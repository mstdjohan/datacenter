<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TradingView XRP/USDT + UT Bot (2,10) + LRC (100,2,2) â€” Email Alerts</title>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    :root{--bg:#0b0f14;--panel:#0f1720;--muted:#8aa0b6;--text:#e6eef7;--accent:#38bdf8;--ok:#22c55e;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--panel);border-bottom:1px solid #1e293b}
    h1{font-size:18px;margin:0}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:12px;padding:12px}
    .card{background:var(--panel);border:1px solid #1e293b;border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,button{background:#09111e;color:var(--text);border:1px solid #213047;border-radius:12px;padding:8px 10px;font-size:13px}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#001018;border:none}
    .badge{padding:3px 8px;border-radius:999px;background:#0b1220;border:1px solid #213047;color:#a7c7de;font-size:11px}
    #tv_chart{height:520px}
    #log{height:220px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#0a0f18;border-radius:12px;padding:10px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .ok{color:var(--ok)}.bad{color:var(--bad)}
    @media(max-width:1100px){.wrap{grid-template-columns:1fr}#tv_chart{height:420px}}
  </style>
</head>
<body>
<header>
  <h1>TradingView â€¢ XRP/USDT â€¢ UT Bot (2,10) + LRC (100,2,2)</h1>
  <div class="row">
    <span class="badge" id="status">Idle</span>
    <button class="primary" id="btnToggle">Start</button>
  </div>
</header>

<div class="wrap">
  <aside class="card">
    <div class="row" style="justify-content:space-between">
      <label>Exchange / Pair</label>
      <span class="badge">BINANCE:XRPUSDT</span>
    </div>

    <div class="row" style="margin-top:8px">
      <label>Timeframe</label>
      <select id="interval">
        <option value="1m">1m</option>
        <option value="3m">3m</option>
        <option value="5m" selected>5m</option>
        <option value="15m">15m</option>
        <option value="1h">1h</option>
      </select>
      <label>Candles</label>
      <select id="limit">
        <option>300</option>
        <option selected>500</option>
        <option>800</option>
        <option>1000</option>
      </select>
    </div>

    <h3 class="muted" style="margin:10px 0 6px">UT Bot (2,10)</h3>
    <div class="row">
      <label>KV</label>
      <input type="number" id="kv" value="2" step="0.1" style="width:80px">
      <label>ATR</label>
      <input type="number" id="atr" value="10" step="1" style="width:80px">
    </div>

    <h3 class="muted" style="margin:10px 0 6px">Linear Regression Channel</h3>
    <div class="row">
      <label>Length</label>
      <input type="number" id="lrLen" value="100" step="1" style="width:80px">
      <label>DevUp</label>
      <input type="number" id="devUp" value="2" step="0.1" style="width:80px">
      <label>DevDn</label>
      <input type="number" id="devDn" value="2" step="0.1" style="width:80px">
    </div>

    <h3 class="muted" style="margin:10px 0 6px">Alarm</h3>
    <div class="row">
      <button id="btnToggleAlarm" class="primary">ðŸ”” Alarm ON</button>
      <button id="btnTest">Test Alarm</button>
    </div>
    <div class="grid" style="margin-top:8px">
      <div>
        <label>Email Service ID</label>
        <input id="emailService" placeholder="e.g. service_xxx">
      </div>
      <div>
        <label>Email Template ID</label>
        <input id="emailTemplate" placeholder="e.g. template_xxx">
      </div>
      <div>
        <label>Public Key</label>
        <input id="emailUser" placeholder="e.g. YOUR_PUBLIC_KEY">
      </div>
      <div>
        <label>Kirim ke Email</label>
        <input id="emailTo" placeholder="nama@domain.com">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnSaveEmail">Simpan EmailJS</button>
      <span id="emailStatus" class="badge">EmailJS: Not set</span>
    </div>

    <div class="muted" style="margin-top:10px">Catatan: sinyal dihitung lokal dari data Binance. Tampilan chart dari TradingView embed.</div>
  </aside>

  <main class="card">
    <div id="tv_chart"></div>
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div><b>Live:</b> <span id="live"></span> â€¢ <span class="muted" id="lastUpdate"></span></div>
        <div><span class="badge" id="trendBadge">Trend: -</span></div>
      </div>
    </div>
    <div id="log" class="card"></div>
  </main>
</div>

<script>
(function(){
  const state={running:false,alarmOn:true,symbol:"XRPUSDT",interval:"5m",limit:500,kv:2,atr:10,lrLen:100,devUp:2,devDn:2,lastTrend:null,lastAlertBar:null,email:{service:'',template:'',user:'',to:''}};
  const $=id=>document.getElementById(id);
  function log(msg){const el=$("log");el.innerHTML=`[${new Date().toLocaleString()}] ${msg}<br>`+el.innerHTML;}
  function setStatus(s){$("status").textContent=s;}
  function beep(){try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.type='sine';o.frequency.value=880;g.gain.value=0.03;o.connect(g);g.connect(ctx.destination);o.start();setTimeout(()=>{o.stop();ctx.close();},250);}catch(_){} }

  function loadEmailCfg(){const raw=localStorage.getItem('emailjs_cfg');if(raw){try{const x=JSON.parse(raw);state.email=x;$("emailService").value=x.service||'';$("emailTemplate").value=x.template||'';$("emailUser").value=x.user||'';$("emailTo").value=x.to||'';if(x.user){emailjs.init(x.user);}updateEmailBadge();}catch(e){}}
  }
  function saveEmailCfg(){state.email.service=$("emailService").value.trim();state.email.template=$("emailTemplate").value.trim();state.email.user=$("emailUser").value.trim();state.email.to=$("emailTo").value.trim();localStorage.setItem('emailjs_cfg',JSON.stringify(state.email));if(state.email.user){emailjs.init(state.email.user);}updateEmailBadge();log('EmailJS disimpan');}
  function updateEmailBadge(){const ok=state.email.service&&state.email.template&&state.email.user&&state.email.to;$("emailStatus").textContent= ok? 'EmailJS: Ready':'EmailJS: Not set'}

  function syncInputs(){state.interval=$("interval").value;state.limit=+$("limit").value;state.kv=+$("kv").value;state.atr=+$("atr").value;state.lrLen=+$("lrLen").value;state.devUp=+$("devUp").value;state.devDn=+$("devDn").value}

  function fmt(n,d=6){return (typeof n==='number'&&isFinite(n))? n.toFixed(d):'-'}
  
  const url = `https://api.binanceproxy.cc/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  
  async function getKlines(symbol, interval, limit) {
  // DexScreener API untuk XRP/USDT (BSC atau lain tergantung pair)
  const url = "https://api.dexscreener.com/latest/dex/tokens/0x55d398326f99059fF775485246999027B3197955"; 
  const r = await fetch(url);
  if (!r.ok) throw new Error("Fetch gagal");

  const raw = await r.json();
  if (!raw || !raw.pairs) throw new Error("Format tidak valid");

  // bikin data dummy OHLC biar bisa tampil di chart
  const price = parseFloat(raw.pairs[0].priceUsd);
  const now = Math.floor(Date.now()/1000);
  return Array.from({length: limit}, (_,i)=>({
    time: now - (limit-i)*60,
    open: price,
    high: price*1.001,
    low: price*0.999,
    close: price,
    volume: 0
  }));
}
  function trueRange(c){const t=[NaN];for(let i=1;i<c.length;i++){const a=c[i],b=c[i-1];const m1=a.high-a.low,m2=Math.abs(a.high-b.close),m3=Math.abs(a.low-b.close);t.push(Math.max(m1,m2,m3))}return t}
  function atr(c,p=10){const t=trueRange(c);let o=new Array(c.length).fill(NaN);let s=0,i=1;while(i<=p&&i<t.length){s+=t[i];i++}if(i<=p)return o;o[p]=s/p;for(let j=p+1;j<t.length;j++){o[j]=(o[j-1]*(p-1)+t[j])/p}return o}
  function utBot(c,kv=2,aP=10){const n=c.length;const r={trend:new Array(n).fill(0),upper:new Array(n).fill(NaN),lower:new Array(n).fill(NaN),line:new Array(n).fill(NaN)};const A=atr(c,aP);let tr=1,up=NaN,dn=NaN;for(let i=0;i<n;i++){const x=c[i];const hl2=(x.high+x.low)/2;const nLoss=kv*A[i];if(!isFinite(nLoss)){r.trend[i]=0;continue}const bU=hl2+nLoss,bL=hl2-nLoss;if(i===0){up=bU;dn=bL}else{const pU=r.upper[i-1];const pL=r.lower[i-1];up=(bU<pU||x.close>pU)?bU:pU;dn=(bL>pL||x.close<pL)?bL:pL}const pT=i>0?r.trend[i-1]:1;tr=x.close>up?1:x.close<dn?-1:pT;const line=tr===1?dn:up;r.trend[i]=tr;r.upper[i]=up;r.lower[i]=dn;r.line[i]=line}return r}
  function linRegChannel(c,l=100,u=2,d=2){const n=c.length;const m=new Array(n).fill(NaN),up=new Array(n).fill(NaN),dn=new Array(n).fill(NaN);for(let i=l-1;i<n;i++){const sl=c.slice(i-l+1,i+1);const y=sl.map(z=>z.close);const M=y.length;const X=[...Array(M).keys()];const SX=X.reduce((a,b)=>a+b,0);const SY=y.reduce((a,b)=>a+b,0);const SXX=X.reduce((a,b)=>a+b*b,0);const SXY=X.reduce((a,b,j)=>a+b*y[j],0);const D=M*SXX-SX*SX;const slope=D!==0?(M*SXY-SX*SY)/D:0;const intercept=(SY-slope*SX)/M;const yHat=intercept+slope*(M-1);const res=y.map((v,j)=>v-(intercept+slope*j));const s2=res.reduce((a,b)=>a+b*b,0)/M;const sd=Math.sqrt(s2);m[i]=yHat;up[i]=yHat+u*sd;dn[i]=yHat-d*sd}return{mid:m,up, dn}}

  async function step(){try{syncInputs();const candles=await getKlines(state.symbol,state.interval,state.limit);if(!candles.length) return;const ut=utBot(candles,state.kv,state.atr);const lr=linRegChannel(candles,state.lrLen,state.devUp,state.devDn);const last=candles[candles.length-1];const prevTrend=ut.trend[ut.trend.length-2]??null;const lastTrend=ut.trend[ut.trend.length-1];$("live").textContent=`${fmt(last.close)} USDT`;$("lastUpdate").textContent=`TF ${state.interval} â€¢ ${new Date(last.time*1000).toLocaleString()}`;$("trendBadge").textContent=`Trend: ${lastTrend>0?'UP':lastTrend<0?'DOWN':'-'}`;const barKey=last.time; if(state.alarmOn){ if(state.lastTrend!==null && state.lastAlertBar!==barKey){ if(prevTrend===-1 && lastTrend===1){fireAlert('BUY', last, lr);} else if(prevTrend===1 && lastTrend===-1){fireAlert('SELL', last, lr);} } } state.lastTrend=lastTrend; state.lastAlertBar=barKey; }catch(e){log('Error: '+e.message);} }

  function fireAlert(side,last,lr){beep();log((side==='BUY'?'ðŸš€ ':'ðŸ”» ')+side+` signal â€¢ ${fmt(last.close)} USDT`); if(state.email.service&&state.email.template&&state.email.user&&state.email.to){ const params={ side, price: fmt(last.close), time: new Date(last.time*1000).toLocaleString(), pair:'XRP/USDT', interval: state.interval, dev_up: fmt(lr.up.at(-1)), dev_dn: fmt(lr.dn.at(-1)), to: state.email.to}; emailjs.send(state.email.service,state.email.template,params).then(()=>{log('Email terkirim')}).catch(err=>{log('Email gagal: '+err.text||err.message)}) } }

  const btnToggle=$("btnToggle");
  const btnAlarm=$("btnToggleAlarm");
  const btnTest=$("btnTest");
  const btnSaveEmail=$("btnSaveEmail");

  btnToggle.onclick=()=>{state.running=!state.running;setStatus(state.running? 'Running':'Stopped');btnToggle.textContent=state.running? 'Stop':'Start'; if(state.running){step(); if(!state._timer) state._timer=setInterval(step,30000);} else { if(state._timer){clearInterval(state._timer);state._timer=null;} } };
  btnAlarm.onclick=()=>{state.alarmOn=!state.alarmOn;btnAlarm.textContent=state.alarmOn? 'ðŸ”” Alarm ON':'ðŸ”• Alarm OFF'};
  btnTest.onclick=()=>{fireAlert('TEST', {close:NaN,time:Math.floor(Date.now()/1000)}, {up:[NaN],dn:[NaN]})};
  btnSaveEmail.onclick=saveEmailCfg;

  new TradingView.widget({autosize:true,symbol:"BINANCE:XRPUSDT",interval:"5",timezone:"Etc/UTC",theme:"dark",style:"1",locale:"en",hide_top_toolbar:false,hide_legend:false,container_id:"tv_chart"});

  loadEmailCfg();
  setStatus('Idle');
  step();
})();
</script>
</body>
</html>
