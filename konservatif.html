<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Strategi Trading CAKE - Mobile Friendly</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    emailjs.init("OGH12a8LlCboHPVz8");
  </script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 10px; background: #f5f5f5; }
    header { text-align: center; padding: 10px; }
    canvas { width: 100% !important; height: auto !important; background: white; border: 1px solid #ccc; border-radius: 8px; }
    .info, #log { background: #fff; padding: 12px; margin: 12px 0; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    #log { white-space: pre-wrap; font-family: monospace; font-size: 13px; }
    .label { font-weight: bold; }
  </style>
</head>
<body>

<header>
  <h2>ðŸ“ˆ CAKE Real-time Strategi</h2>
</header>

<div class="info">
  <div>ðŸ’° Harga Live: <span id="livePrice">Memuat...</span></div>
  <div>ðŸª™ Modal: <span id="capital">$1000.00</span></div>
</div>

<canvas id="chart"></canvas>

<div class="info">
  <h4>Riwayat Log</h4>
  <div id="log"></div>
</div>

<script>
let priceData = [], timeLabels = [];
let currentCapital = 1000, qtyPerTrade = 100, lastBuy = null;
let highestSinceBuy = null, currentPositionAmount = 0;

const chartCtx = document.getElementById('chart').getContext('2d');
const chart = new Chart(chartCtx, {
  type: 'line',
  data: {
    labels: timeLabels,
    datasets: [
      { label: 'Harga', data: priceData, borderColor: 'black', fill: false },
      { label: 'EMA-12', data: [], borderColor: 'blue', fill: false },
      { label: 'EMA-26', data: [], borderColor: 'purple', fill: false },
      { label: 'SMA-10', data: [], borderColor: 'orange', fill: false },
      { label: 'Upper BB', data: [], borderColor: 'green', borderDash: [5,5], fill: false },
      { label: 'Lower BB', data: [], borderColor: 'red', borderDash: [5,5], fill: false },
      { label: 'RSI', data: [], borderColor: 'brown', fill: false, yAxisID: 'y1' },
      { label: 'MACD', data: [], borderColor: 'teal', fill: false, yAxisID: 'y1' },
    ]
  },
  options: {
    responsive: true,
    scales: {
      x: { display: true },
      y: { display: true, position: 'left' },
      y1: { display: true, position: 'right', grid: { drawOnChartArea: false } }
    }
  }
});

function log(msg) {
  const logDiv = document.getElementById("log");
  logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logDiv.textContent;
}

function updateCapitalDisplay() {
  document.getElementById("capital").textContent = `$${currentCapital.toFixed(2)}`;
}

function sendEmail(subject, body) {
  emailjs.send("service_5hxo1hk", "template_iq87egh", {
    subject: subject,
    body: body,
    time: new Date().toLocaleString()
  }).then(() => {
    log(`ðŸ“§ Email terkirim: ${subject}`);
  }).catch(err => {
    log("âš ï¸ Gagal kirim email: " + err.text);
  });
}

function calculateSMA(data, period) {
  return data.map((_, i) => i < period - 1 ? null :
    data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0) / period);
}
function calculateEMA(data, period) {
  const k = 2 / (period + 1);
  let ema = data[0];
  return data.map((price, i) => {
    if (i === 0) return ema;
    ema = price * k + ema * (1 - k);
    return ema;
  });
}
function calculateBollingerBands(data, period = 20, multiplier = 2) {
  const sma = calculateSMA(data, period);
  const upper = [], lower = [];
  for (let i = 0; i < data.length; i++) {
    if (i < period - 1) { upper.push(null); lower.push(null); }
    else {
      const slice = data.slice(i - period + 1, i + 1);
      const mean = sma[i];
      const std = Math.sqrt(slice.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / period);
      upper.push(mean + multiplier * std);
      lower.push(mean - multiplier * std);
    }
  }
  return { upper, lower };
}
function calculateRSI(data, period = 14) {
  let gains = 0, losses = 0, rsi = [];
  for (let i = 1; i < data.length; i++) {
    let diff = data[i] - data[i - 1];
    if (i <= period) {
      if (diff >= 0) gains += diff; else losses -= diff;
      rsi.push(null);
    } else {
      let avgGain = gains / period;
      let avgLoss = losses / period;
      let rs = avgGain / (avgLoss || 1);
      rsi.push(100 - (100 / (1 + rs)));
      let delta = data[i] - data[i - 1];
      if (delta >= 0) {
        gains = (gains * (period - 1) + delta) / period;
        losses = (losses * (period - 1)) / period;
      } else {
        gains = (gains * (period - 1)) / period;
        losses = (losses * (period - 1) - delta) / period;
      }
    }
  }
  return rsi;
}

function checkStrategy() {
  const latest = priceData[priceData.length - 1];
  const bb = calculateBollingerBands(priceData);
  const lowerBB = bb.lower[bb.lower.length - 1];
  const upperBB = bb.upper[bb.upper.length - 1];
  const rsi = calculateRSI(priceData);
  const rsiLatest = rsi[rsi.length - 1];

  document.getElementById("livePrice").textContent = `$${latest.toFixed(4)}`;

  if (!lastBuy && latest < lowerBB && rsiLatest < 30) {
    lastBuy = latest;
    currentPositionAmount = qtyPerTrade / latest;
    currentCapital -= qtyPerTrade;
    highestSinceBuy = latest;
    updateCapitalDisplay();
    log(`BUY ðŸŸ¢ di $${latest.toFixed(4)} (RSI: ${rsiLatest.toFixed(1)})`);
    sendEmail("BUY Signal", `Pair: CAKE/USDT\nHarga: $${latest.toFixed(4)}\nRSI: ${rsiLatest.toFixed(1)}\nWaktu: ${new Date().toLocaleTimeString()}`);
  }
  if (lastBuy) {
    if (latest > highestSinceBuy) highestSinceBuy = latest;
    const trailingStop = highestSinceBuy * 0.989;
    if (latest < trailingStop) {
      const sellValue = currentPositionAmount * latest;
      currentCapital += sellValue;
      log(`SELL ðŸ”´ di $${latest.toFixed(4)} | Profit: $${(sellValue - qtyPerTrade).toFixed(2)}`);
      sendEmail("SELL Signal", `Pair: CAKE/USDT\nHarga: $${latest.toFixed(4)}\nWaktu: ${new Date().toLocaleTimeString()}`);
      lastBuy = null;
      currentPositionAmount = 0;
      updateCapitalDisplay();
    }
  }
}

async function fetchInitialData() {
  const res = await fetch("https://api.coingecko.com/api/v3/coins/pancakeswap-token/market_chart?vs_currency=usd&days=2");
  const data = await res.json();
  data.prices.forEach(p => {
    priceData.push(p[1]);
    timeLabels.push(new Date(p[0]).toLocaleTimeString());
  });
  updateIndicators();
  chart.update();
  checkStrategy();
}

function updateIndicators() {
  chart.data.datasets[1].data = calculateEMA(priceData, 12);
  chart.data.datasets[2].data = calculateEMA(priceData, 26);
  chart.data.datasets[3].data = calculateSMA(priceData, 10);
  const bb = calculateBollingerBands(priceData);
  chart.data.datasets[4].data = bb.upper;
  chart.data.datasets[5].data = bb.lower;
  chart.data.datasets[6].data = calculateRSI(priceData);
  chart.data.datasets[7].data = calculateMACD(priceData).macd;
}

setInterval(async () => {
  const res = await fetch("https://api.dexscreener.com/latest/dex/pairs/bsc/0x0eD7e52944161450477ee417DE9Cd3a859b14fD0");
  const data = await res.json();
  const price = parseFloat(data.pair.priceUsd);
  priceData.push(price);
  timeLabels.push(new Date().toLocaleTimeString());
  if (priceData.length > 200) {
    priceData.shift();
    timeLabels.shift();
  }
  updateIndicators();
  chart.update();
  checkStrategy();
}, 30000);

fetchInitialData();
</script>
</body>
</html>
