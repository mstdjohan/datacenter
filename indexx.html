<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auto Trade CAKE/USDT</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f4f4f4; }
    canvas { background: #fff; border: 1px solid #ccc; border-radius: 10px; }
    #log { margin-top: 20px; font-size: 14px; white-space: pre-line; background: #fff; padding: 10px; border-radius: 5px; }
    #controls { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Auto Trade CAKE/USDT</h2>
  <canvas id="chart" width="600" height="300"></canvas>
  <div id="controls">
    <button onclick="resetModal()">🔄 Reset Modal</button>
    <div>💰 Modal: <span id="modal"></span> USDT</div>
  </div>
  <div id="log"></div>

  <script>
    emailjs.init("aPZx0R9oxUbIQkLEv"); // Public Key

    const chartEl = document.getElementById("chart");
    const ctx = chartEl.getContext("2d");
    let priceData = [];
    let labels = [];
    let modal = parseFloat(localStorage.getItem("modal")) || 1000;
    let lastSignal = localStorage.getItem("lastSignal") || "";
    let chart;

    document.getElementById("modal").textContent = modal.toFixed(2);

    const log = (msg) => {
      const logDiv = document.getElementById("log");
      logDiv.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    };

    function resetModal() {
      modal = 1000;
      localStorage.setItem("modal", modal);
      document.getElementById("modal").textContent = modal.toFixed(2);
      log("🔁 Modal direset ke $1000");
    }

    async function fetchPrice() {
      try {
        const res = await fetch("https://api.dexscreener.com/latest/dex/pairs/bsc/0xA39af17CE4a8Eb807e076805DA1E2B8EA7D0755b");
        const json = await res.json();
        return parseFloat(json.pair.priceUsd);
      } catch {
        log("⚠️ Gagal ambil harga.");
        return null;
      }
    }

    function sendEmail(subject, body) {
      if (localStorage.getItem("lastEmail") === subject) return;
      emailjs.send("service_d48312b", "template_1ktk40q", {
        subject,
        body,
        time: new Date().toLocaleString()
      }).then(() => log("📧 Email: " + subject));
      localStorage.setItem("lastEmail", subject);
    }

    function updateChart(price) {
      labels.push(new Date().toLocaleTimeString());
      priceData.push(price);
      if (priceData.length > 20) {
        labels.shift();
        priceData.shift();
      }
      chart.data.labels = labels;
      chart.data.datasets[0].data = priceData;
      chart.update();
    }

    function checkSignal() {
      const n = priceData.length;
      if (n < 5) return;

      const last = priceData[n - 1];
      const prev1 = priceData[n - 2];
      const prev2 = priceData[n - 3];
      const prev3 = priceData[n - 4];

      const drop = prev3 > prev2 && prev2 > prev1 && last > prev1;
      const rally = last < prev1;

      if (drop && lastSignal !== "buy") {
        lastSignal = "buy";
        modal += 50;
        localStorage.setItem("modal", modal);
        localStorage.setItem("lastSignal", lastSignal);
        document.getElementById("modal").textContent = modal.toFixed(2);
        sendEmail("BUY Signal", `Harga: ${last}`);
        log("🟩 BUY @ $" + last.toFixed(4));
        chart.data.datasets[1].data.push({ x: labels[n - 1], y: last });
      } else if (rally && lastSignal === "buy") {
        lastSignal = "sell";
        modal += 80;
        localStorage.setItem("modal", modal);
        localStorage.setItem("lastSignal", lastSignal);
        document.getElementById("modal").textContent = modal.toFixed(2);
        sendEmail("SELL Signal", `Harga: ${last}`);
        log("🟥 SELL @ $" + last.toFixed(4));
        chart.data.datasets[2].data.push({ x: labels[n - 1], y: last });
      }
    }

    function initChart() {
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "CAKE/USDT",
              data: priceData,
              borderColor: "#4444dd",
              fill: false
            },
            {
              label: "Buy",
              data: [],
              backgroundColor: "green",
              pointRadius: 5,
              showLine: false
            },
            {
              label: "Sell",
              data: [],
              backgroundColor: "red",
              pointRadius: 5,
              showLine: false
            }
          ]
        },
        options: {
          responsive: false,
          scales: {
            x: { display: false },
            y: { beginAtZero: false }
          }
        }
      });
    }

    async function loop() {
      const price = await fetchPrice();
      if (price) {
        updateChart(price);
        checkSignal();
      }
      setTimeout(loop, 30000);
    }

    initChart();
    loop();
  </script>
</body>
</html>
