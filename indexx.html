<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simulasi Trading CAKE/USDT</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@1/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    canvas { background: #fff; border: 1px solid #ccc; }
    #log { margin-top: 20px; white-space: pre-line; background: #fff; padding: 10px; border: 1px solid #ccc; height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>Simulasi Trading CAKE/USDT (CoinGecko)</h2>
  <canvas id="chart" width="800" height="400"></canvas>
  <div id="info">
    <p>Saldo: <span id="balance">$1000</span> | Posisi: <span id="position">-</span></p>
  </div>
  <div id="log">Log transaksi:</div>

  <script>
    const ctx = document.getElementById("chart").getContext("2d");
    let candleData = [];
    let chart;
    let lastPrice = 0;

    // Simulasi modal dan posisi
    let balance = 1000;
    let holding = 0;
    let entryPrice = 0;

    // Inisialisasi chart candlestick
    function initChart() {
      chart = new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: 'CAKE/USDT',
            data: candleData,
            color: {
              up: 'green',
              down: 'red',
              unchanged: 'gray'
            }
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                tooltipFormat: 'HH:mm'
              }
            },
            y: {
              beginAtZero: false
            }
          }
        }
      });
    }

    // Ambil data OHLC dari CoinGecko (24 jam, interval 1 menit)
    async function fetchOHLC() {
      try {
        const res = await fetch("https://api.coingecko.com/api/v3/coins/pancakeswap-token/ohlc?vs_currency=usd&days=1");
        const data = await res.json();
        candleData = data.map(item => ({
          x: new Date(item[0]),
          o: item[1],
          h: item[2],
          l: item[3],
          c: item[4]
        }));

        if (!chart) {
          initChart();
        } else {
          chart.data.datasets[0].data = candleData;
          chart.update();
        }

        evaluateStrategy();

      } catch (e) {
        console.error("Gagal ambil data OHLC:", e);
      }
    }

    // Simulasi strategi trading sederhana
    function evaluateStrategy() {
      const latest = candleData[candleData.length - 1];
      const currentPrice = latest.c;

      // Simulasi logika BUY
      if (!holding && currentPrice < lastPrice * 0.99) {
        // Beli saat turun 1%
        holding = balance / currentPrice;
        entryPrice = currentPrice;
        balance = 0;
        log(`ðŸŸ¢ BUY di $${currentPrice.toFixed(2)} | Jumlah: ${holding.toFixed(2)} CAKE`);
      }

      // Simulasi logika SELL
      else if (holding && currentPrice > entryPrice * 1.01) {
        // Jual saat naik 1%
        balance = holding * currentPrice;
        log(`ðŸ”´ SELL di $${currentPrice.toFixed(2)} | Saldo: $${balance.toFixed(2)} | Profit: ${(balance - 1000).toFixed(2)}`);
        holding = 0;
        entryPrice = 0;
      }

      lastPrice = currentPrice;
      updateUI(currentPrice);
    }

    function log(message) {
      const logDiv = document.getElementById("log");
      logDiv.textContent += `\n[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateUI(price) {
      document.getElementById("balance").textContent = `$${balance.toFixed(2)}`;
      document.getElementById("position").textContent = holding > 0 ? `${holding.toFixed(2)} CAKE (Avg: $${entryPrice.toFixed(2)})` : "-";
    }

    // Fetch awal dan interval update tiap 30 detik
    fetchOHLC();
    setInterval(fetchOHLC, 30000);
  </script>
</body>
</html>
