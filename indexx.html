<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Trading CAKE/USDT</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 10px; }
    #chart { height: 300px; width: 100%; margin-top: 20px; background: white; border: 1px solid #ccc; }
    #log { background: #fff; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; margin-top: 20px; font-size: 12px; }
    #modalInfo { margin-top: 10px; font-weight: bold; }
    .buy { color: green; }
    .sell { color: red; }
  </style>
</head>
<body>
  <h2>üìà CAKE/USDT Auto Trading System</h2>
  <canvas id="chart"></canvas>
  <div id="modalInfo"></div>
  <button onclick="resetModal()">üîÑ Reset Modal</button>
  <div id="log"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let prices = [], labels = [], trades = [], modal = parseFloat(localStorage.getItem("modal")) || 1000;
    let buyPrice = null;
    const ctx = document.getElementById('chart').getContext('2d');

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'CAKE/USDT Price',
          data: prices,
          borderColor: '#007bff',
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
        }]
      },
      options: {
        animation: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: { beginAtZero: false }
        }
      }
    });

    function log(msg) {
      const logBox = document.getElementById("log");
      logBox.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + logBox.innerHTML;
    }

    function resetModal() {
      localStorage.setItem("modal", 1000);
      modal = 1000;
      document.getElementById("modalInfo").textContent = `üí∞ Modal: $${modal.toFixed(2)}`;
      log("Modal di-reset ke $1000");
    }

    function calculateRSI(closes, period = 14) {
      if (closes.length < period + 1) return null;
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        const change = closes[closes.length - i] - closes[closes.length - i - 1];
        if (change > 0) gains += change;
        else losses -= change;
      }
      const avgGain = gains / period;
      const avgLoss = losses / period;
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    async function fetchPrice() {
      try {
        const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=pancakeswap-token&vs_currencies=usd");
        const data = await res.json();
        const price = data["pancakeswap-token"].usd;
        const now = new Date().toLocaleTimeString();
        if (prices.length >= 100) {
          prices.shift();
          labels.shift();
        }
        prices.push(price);
        labels.push(now);
        chart.update();

        const rsi = calculateRSI(prices);
        if (rsi !== null) {
          const low = Math.min(...prices.slice(-10));
          const high = Math.max(...prices.slice(-10));
          if (price <= low && rsi < 30 && !buyPrice) {
            buyPrice = price;
            trades.push({ type: "buy", price, time: now });
            localStorage.setItem("modal", modal);
            chart.data.datasets.push({
              type: 'scatter',
              label: 'BUY',
              data: [{ x: now, y: price }],
              pointBackgroundColor: 'green',
              pointRadius: 5,
              showLine: false,
            });
            log(`üü¢ BUY @ $${price.toFixed(4)} (RSI: ${rsi.toFixed(1)})`);
          } else if (price >= high && rsi > 70 && buyPrice) {
            const profit = (price - buyPrice) / buyPrice * modal;
            modal += profit;
            buyPrice = null;
            trades.push({ type: "sell", price, time: now });
            localStorage.setItem("modal", modal);
            chart.data.datasets.push({
              type: 'scatter',
              label: 'SELL',
              data: [{ x: now, y: price }],
              pointBackgroundColor: 'red',
              pointRadius: 5,
              showLine: false,
            });
            log(`üî¥ SELL @ $${price.toFixed(4)} | üí∞ Modal: $${modal.toFixed(2)} (RSI: ${rsi.toFixed(1)})`);
          }
        }

        document.getElementById("modalInfo").textContent = `üí∞ Modal: $${modal.toFixed(2)} | RSI: ${rsi ? rsi.toFixed(1) : "-"}`;
      } catch (err) {
        log("‚ö†Ô∏è Gagal ambil harga: " + err.message);
      }
    }

    setInterval(fetchPrice, 30000);
    fetchPrice();
    resetModal();
  </script>
</body>
</html>
