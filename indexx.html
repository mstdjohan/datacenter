<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XRP Buy/Sell Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    canvas { max-width: 100%; background: #111; }
  </style>
</head>
<body>
  <h2 style="color:white">XRP/USDT Buy/Sell Signal</h2>
  <canvas id="priceChart" width="900" height="400"></canvas>

  <script>
    const ctx = document.getElementById('priceChart').getContext('2d');
    let chart;

    const fetchPrices = async () => {
      try {
        const now = Math.floor(Date.now() / 1000);
        const from = now - 60 * 60 * 2; // 2 jam terakhir
        const url = `https://api.coingecko.com/api/v3/coins/ripple/market_chart/range?vs_currency=usd&from=${from}&to=${now}`;
        const res = await fetch(url);
        const data = await res.json();

        const prices = data.prices.map(p => ({ time: new Date(p[0]), price: p[1] }));
        return prices;
      } catch (e) {
        console.error("âŒ Gagal fetch data:", e);
        return [];
      }
    };

    const detectSignals = (prices) => {
      const buySignals = [];
      const sellSignals = [];

      for (let i = 5; i < prices.length; i++) {
        const recent = prices.slice(i - 5, i);
        const change = ((prices[i].price - recent[0].price) / recent[0].price) * 100;

        if (change <= -2) buySignals.push({ x: prices[i].time, y: prices[i].price });
        if (change >= 2) sellSignals.push({ x: prices[i].time, y: prices[i].price });
      }

      return { buySignals, sellSignals };
    };

    const updateChart = async () => {
      const prices = await fetchPrices();
      if (prices.length < 6) return;

      const labels = prices.map(p => p.time);
      const priceData = prices.map(p => p.price);
      const { buySignals, sellSignals } = detectSignals(prices);

      const datasets = [
        {
          label: 'XRP/USDT',
          data: priceData,
          borderColor: 'white',
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
        },
        {
          label: 'Buy',
          data: buySignals,
          backgroundColor: 'green',
          pointStyle: 'triangle',
          pointRadius: 7,
          showLine: false
        },
        {
          label: 'Sell',
          data: sellSignals,
          backgroundColor: 'red',
          pointStyle: 'rectRot',
          pointRadius: 7,
          showLine: false
        }
      ];

      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets = datasets;
        chart.update();
      } else {
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: 'white' } }
            },
            scales: {
              x: { ticks: { color: 'white' } },
              y: { ticks: { color: 'white' } }
            }
          }
        });
      }
    };

    // Run first and refresh every 30 seconds
    updateChart();
    setInterval(updateChart, 30000);
  </script>
</body>
</html>
