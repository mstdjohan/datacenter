<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AutoSwap Pancake ‚Äî USDT ‚Üî XRP (BSC)</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  body{font-family:system-ui,Arial,sans-serif;background:#0b1220;color:#e5e7eb;margin:0;padding:0}
  .wrap{max-width:980px;margin:24px auto;padding:16px}
  h1{font-size:18px;margin:0 0 8px}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:12px}
  label{font-size:12px;color:#9ca3af}
  input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  button{cursor:pointer}
  .muted{color:#9ca3af;font-size:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .pct{display:flex;gap:6px;margin-top:6px}
  .pct button{flex:1}
  .ok{background:#065f46;border-color:#065f46}
  .danger{background:#7f1d1d;border-color:#7f1d1d}
  #log{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;height:230px;overflow:auto;background:#0b1220;border:1px dashed #374151;border-radius:10px;padding:10px}
  .stat{display:flex;justify-content:space-between;gap:8px;background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:8px;margin:6px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>üîÅ AutoSwap Pancake ‚Äî USDT ‚Üî XRP (BSC)</h1>
  <div class="muted">Router price real-time (getAmountsOut), slippage default 0.1%, Start/Stop bot + TP/SL.</div>

  <div class="grid" style="margin-top:12px">
    <!-- Left controls -->
    <div class="card">
      <div class="row">
        <button id="btnConnect" class="ok">üîó Connect Wallet</button>
        <button id="btnDisconnect">‚õî Disconnect</button>
      </div>

      <div class="stat"><div>Address</div><div id="address">‚Äî</div></div>
      <div class="stat"><div>Network</div><div id="network">‚Äî</div></div>
      <div class="stat"><div>BNB</div><div id="bnb">‚Äî</div></div>

      <div style="margin-top:8px">
        <label>Mode</label>
        <select id="mode">
          <option value="buy">BUY (USDT ‚Üí XRP)</option>
          <option value="sell">SELL (XRP ‚Üí USDT)</option>
        </select>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Token From</label>
          <input id="tokenFrom" value="0x55d398326f99059fF775485246999027B3197955"/>
        </div>
        <div>
          <label>Token To</label>
          <input id="tokenTo" value="0x1D2F0da169ceB9fC7B3144628dB156f3F6c60dBE"/>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Decimals From</label>
          <input id="decFrom" value="18" disabled/>
        </div>
        <div>
          <label>Decimals To</label>
          <input id="decTo" value="18" disabled/>
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Amount (From)</label>
        <input id="amount" placeholder="e.g. 10"/>
        <div class="pct">
          <button data-pct="25">25%</button>
          <button data-pct="50">50%</button>
          <button data-pct="75">75%</button>
          <button data-pct="100">100%</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Slippage (%)</label>
          <input id="slippage" value="0.1"/>
        </div>
        <div>
          <label>Deadline (min)</label>
          <input id="deadline" value="5"/>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>TP (take profit)</label>
          <input id="tp" placeholder="USDT/XRP for SELL, or USDT per XRP for BUY"/>
        </div>
        <div>
          <label>SL (stop loss)</label>
          <input id="sl" placeholder="USDT/XRP for SELL, or USDT per XRP for BUY"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnQuote">üîç Get Quote</button>
        <button id="btnSwap" class="ok">‚ö° Swap Now</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnStart" class="ok">‚ñ∂Ô∏è Start Bot</button>
        <button id="btnStop" class="danger" disabled>‚è∏Ô∏è Stop Bot</button>
      </div>

      <div class="stat"><div>Router DirPrice</div><div id="dir">‚Äî</div></div>
      <div class="stat"><div>Exec (with slippage)</div><div id="exec">‚Äî</div></div>
      <div class="stat"><div>Path</div><div id="path">‚Äî</div></div>
    </div>

    <!-- Right log -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="muted">Activity Log</div>
        <button id="btnClear">üßπ Clear</button>
      </div>
      <div id="log"></div>
    </div>
  </div>
</div>

<script>
/* ====== CONSTS ====== */
const BSC_CHAIN_ID = 56;
const ROUTER = "0x10ED43C718714eb63d5aA57B78B54704E256024E"; // Pancake V2
const USDT = "0x55d398326f99059fF775485246999027B3197955";
const XRP  = "0x1D2F0da169ceB9fC7B3144628dB156f3F6c60dBE";

const routerAbi = [
  "function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory)",
  "function swapExactTokensForTokensSupportingFeeOnTransferTokens(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) external"
];
const erc20Abi = [
  "function decimals() view returns(uint8)",
  "function balanceOf(address) view returns(uint256)",
  "function allowance(address,address) view returns(uint256)",
  "function approve(address,uint256) returns(bool)"
];

/* ====== STATE ====== */
let rawProvider=null, web3p=null, signer=null, account=null;
let botTimer=null;

/* ====== UI helpers ====== */
const el = id => document.getElementById(id);
function log(msg){ const t = new Date().toLocaleTimeString(); el('log').textContent = `[${t}] ${msg}\n` + el('log').textContent; }
function fmt(n, d=6){ const x = Number(n); if(!isFinite(x)) return String(n); return x.toFixed(d); }

/* ====== Provider connect ====== */
function patchProvider(p){
  // Some injected providers miss EventEmitter bits
  if(!p) return;
  if(typeof p.on!=='function'){ p.on = ()=>{}; }
  if(typeof p.removeListener!=='function'){ p.removeListener=()=>{}; }
  if(typeof p.addListener!=='function'){ p.addListener=()=>{}; }
  return p;
}

async function connect(){
  if(!window.ethereum){ alert('Wallet tidak ditemukan. Install MetaMask/Trust Wallet Browser.'); return; }
  try{
    rawProvider = patchProvider(window.ethereum);
    web3p = new ethers.providers.Web3Provider(rawProvider, 'any');
    await web3p.send('eth_requestAccounts', []);
    signer = web3p.getSigner();
    account = await signer.getAddress();
    el('address').textContent = account;
    const net = await web3p.getNetwork();
    el('network').textContent = `${net.name} (${net.chainId})`;
    if(Number(net.chainId)!==BSC_CHAIN_ID) alert('Switch ke Binance Smart Chain Mainnet');
    const bnb = await web3p.getBalance(account);
    el('bnb').textContent = `${fmt(ethers.utils.formatEther(bnb),6)} BNB`;
    await refreshMeta();
    log('‚úÖ Connected');
  }catch(e){ log('Connect error: '+(e.message||e)); }
}

async function disconnect(){
  try{
    if(rawProvider && typeof rawProvider.disconnect==='function'){ await rawProvider.disconnect(); }
  }catch(e){}
  rawProvider=null; web3p=null; signer=null; account=null;
  ['address','network','bnb','dir','exec','path'].forEach(id=>el(id).textContent='‚Äî');
  log('Disconnected');
}

/* ====== Token meta & balance ====== */
async function readDecimals(addr){
  const c = new ethers.Contract(addr, erc20Abi, web3p);
  return await c.decimals();
}

async function refreshMeta(){
  try{
    const mode = el('mode').value;
    if(mode==='buy'){ el('tokenFrom').value=USDT; el('tokenTo').value=XRP; }
    else { el('tokenFrom').value=XRP; el('tokenTo').value=USDT; }
    const dF = await readDecimals(el('tokenFrom').value);
    const dT = await readDecimals(el('tokenTo').value);
    el('decFrom').value = dF; el('decTo').value = dT;
  }catch(e){ log('refreshMeta error: '+(e.message||e)); }
}

async function getBalanceHuman(addr){
  if(!account) return 0;
  const c = new ethers.Contract(addr, erc20Abi, web3p);
  const dec = await c.decimals();
  const bal = await c.balanceOf(account);
  return parseFloat(ethers.utils.formatUnits(bal, dec));
}

async function autoFillAmountFromBalance(pct=100){
  try{
    const bal = await getBalanceHuman(el('tokenFrom').value);
    const val = bal * (pct/100);
    el('amount').value = (val>0? val.toString() : '');
    log(`Auto-fill ${pct}%: ${val}`);
  }catch(e){ log('autoFill error: '+(e.message||e)); }
}

/* ====== Quote & swap ====== */
function pctDiff(a,b){ return ( (a-b)/b )*100; }

async function quote(){
  try{
    const tokenFrom = el('tokenFrom').value;
    const tokenTo   = el('tokenTo').value;
    const decF = Number(el('decFrom').value)||18;
    const amt = parseFloat(el('amount').value||'0');
    if(!amt || amt<=0){ log('Masukkan amount'); return; }
    const router = new ethers.Contract(ROUTER, routerAbi, web3p);
    const path=[tokenFrom, tokenTo];
    const amountIn = ethers.utils.parseUnits(amt.toString(), decF);
    const outs = await router.getAmountsOut(amountIn, path);
    const outHuman = parseFloat(ethers.utils.formatUnits(outs[outs.length-1], Number(el('decTo').value)||18));

    // Directional price display (USDT per XRP OR USDT/XRP)
    let dirPrice, execPrice;
    if(tokenFrom.toLowerCase()===USDT.toLowerCase()){
      // BUY: 1 USDT -> x XRP, so USDT/XRP = 1 / x
      const xrpPerUsdt = outHuman/amt;
      dirPrice = 1 / xrpPerUsdt; // USDT per 1 XRP
      const slip = (parseFloat(el('slippage').value)||0.1)/100;
      execPrice = dirPrice * (1 + slip); // slippage worsens price
    }else{
      // SELL: 1 XRP -> x USDT, so USDT/XRP = x / 1
      const usdtPerXrp = outHuman/amt;
      dirPrice = usdtPerXrp;
      const slip = (parseFloat(el('slippage').value)||0.1)/100;
      execPrice = dirPrice * (1 - slip);
    }

    el('dir').textContent  = `${fmt(dirPrice,6)} USDT/XRP`;
    el('exec').textContent = `${fmt(execPrice,6)} USDT/XRP`;
    el('path').textContent = path.map(p=>p.slice(0,6)+'‚Ä¶'+p.slice(-4)).join(' ‚Üí ');
    return {dirPrice, execPrice, outHuman, path, amountIn};
  }catch(e){ log('Quote error: '+(e.message||e)); return null; }
}

async function ensureAllowance(token, owner, spender, needed){
  const c = new ethers.Contract(token, erc20Abi, signer);
  const allow = await c.allowance(owner, spender);
  if(allow.gte(needed)) return;
  log('Approving max allowance‚Ä¶');
  const tx = await c.approve(spender, ethers.constants.MaxUint256);
  await tx.wait();
  log('Approve confirmed');
}

async function doSwap(){
  try{
    if(!signer || !account){ alert('Connect wallet dulu'); return; }
    const q = await quote(); if(!q) return;

    const tokenFrom = el('tokenFrom').value;
    const tokenTo   = el('tokenTo').value;
    const router = new ethers.Contract(ROUTER, routerAbi, signer);
    const slip = (parseFloat(el('slippage').value)||0.1)/100;
    const deadlineMin = Math.max(1, parseInt(el('deadline').value||'5',10));
    const dl = Math.floor(Date.now()/1000) + 60*deadlineMin;

    // Min out (conservative for both directions)
    const amountOutMin = 0;

    await ensureAllowance(tokenFrom, account, ROUTER, q.amountIn);
    const tx = await router.swapExactTokensForTokensSupportingFeeOnTransferTokens(
      q.amountIn,
      amountOutMin,
      [tokenFrom, tokenTo],
      account,
      dl
    );
    log('Swap sent: '+tx.hash);
    await tx.wait();
    log('‚úÖ Swap confirmed');
  }catch(e){ log('Swap error: '+(e.data?.message || e.message || e)); }
}

/* ====== Bot loop (simple TP/SL) ====== */
async function checkAndAct(){
  try{
    const q = await quote(); if(!q) return;
    const tp = parseFloat(el('tp').value||'');
    const sl = parseFloat(el('sl').value||'');
    const mode = el('mode').value;
    if(mode==='sell'){
      if(isFinite(tp) && q.execPrice >= tp){ log(`TP hit (‚â• ${tp}) ‚Üí SELL`); await doSwap(); return; }
      if(isFinite(sl) && q.execPrice <= sl){ log(`SL hit (‚â§ ${sl}) ‚Üí SELL`); await doSwap(); return; }
    }else{
      if(isFinite(tp) && q.execPrice <= tp){ log(`TP hit (‚â§ ${tp}) ‚Üí BUY`); await doSwap(); return; }
      if(isFinite(sl) && q.execPrice >= sl){ log(`SL hit (‚â• ${sl}) ‚Üí BUY`); await doSwap(); return; }
    }
    log(`HOLD | Exec ${fmt(q.execPrice)} USDT/XRP`);
  }catch(e){ log('bot error: '+(e.message||e)); }
}

/* ====== Events ====== */
el('btnConnect').addEventListener('click', connect);
el('btnDisconnect').addEventListener('click', disconnect);
el('btnQuote').addEventListener('click', quote);
el('btnSwap').addEventListener('click', doSwap);
el('btnStart').addEventListener('click', ()=>{
  if(botTimer) return;
  botTimer = setInterval(checkAndAct, 8000);
  el('btnStart').disabled=true; el('btnStop').disabled=false;
  log('Bot started');
});
el('btnStop').addEventListener('click', ()=>{
  if(botTimer){ clearInterval(botTimer); botTimer=null; log('Bot stopped'); }
  el('btnStart').disabled=false; el('btnStop').disabled=true;
});
el('btnClear').addEventListener('click', ()=>{ el('log').textContent=''; });

document.querySelectorAll('.pct button').forEach(b=>{
  b.addEventListener('click', ()=> autoFillAmountFromBalance(Number(b.getAttribute('data-pct'))||100) );
});

el('mode').addEventListener('change', refreshMeta);

/* ====== Init ====== */
(async ()=>{
  // attempt passive connection info (no popups)
  if(window.ethereum){
    try{
      rawProvider = patchProvider(window.ethereum);
      web3p = new ethers.providers.Web3Provider(rawProvider, 'any');
      const accs = await web3p.listAccounts();
      if(accs.length){
        signer = web3p.getSigner();
        account = accs[0];
        el('address').textContent = account;
        const net = await web3p.getNetwork();
        el('network').textContent = `${net.name} (${net.chainId})`;
        const bnb = await web3p.getBalance(account);
        el('bnb').textContent = `${fmt(ethers.utils.formatEther(bnb),6)} BNB`;
      }
    }catch(e){}
  }
  await refreshMeta();
})();
</script>
</body>
</html>
