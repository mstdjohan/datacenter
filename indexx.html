<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Auto Trading CAKE/USDT Candlestick</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>
</head>
<body style="font-family:sans-serif;text-align:center;background:#f0f0f0;padding:20px;">

  <h2>üìà CAKE/USDT Auto Trading (Candlestick Chart)</h2>
  <canvas id="chart" width="400" height="300"></canvas>
  <p id="livePrice">Live: $0.0000</p>
  <p id="signal"></p>
  <div id="log" style="background:#fff;border:1px solid #ccc;padding:10px;margin:20px auto;width:90%;max-width:500px;text-align:left;"></div>

  <script>
    emailjs.init("OGH12a8LlCboHPVz8");

    const chartCtx = document.getElementById("chart").getContext("2d");
    let priceData = [];

    const chart = new Chart(chartCtx, {
      type: 'candlestick',
      data: {
        datasets: [{
          label: 'CAKE/USDT',
          data: [],
          borderColor: 'black',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            time: { unit: 'minute' },
            ticks: { source: 'auto' },
            adapters: { date: { locale: 'en-US' } },
            type: 'time'
          },
          y: {
            beginAtZero: false
          }
        }
      }
    });

    let capital = 1000;
    let position = 0;
    let avgBuyPrice = 0;
    let lastSignal = '';

    function logTrade(msg) {
      const log = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      log.innerHTML = `<div>[${time}] ${msg}</div>` + log.innerHTML;
    }

    function pushNewCandle(price) {
      const now = new Date();
      const last = priceData[priceData.length - 1];

      if (last && now.getMinutes() === new Date(last.t).getMinutes()) {
        last.h = Math.max(last.h, price);
        last.l = Math.min(last.l, price);
        last.c = price;
      } else {
        priceData.push({
          t: now,
          o: price,
          h: price,
          l: price,
          c: price
        });
        if (priceData.length > 60) priceData.shift();
      }
    }

    function evaluateSignal(price) {
      const support = 2.70;
      const resistance = 2.90;

      if (price < support && lastSignal !== 'BUY') {
        const qty = capital / price;
        position = qty;
        avgBuyPrice = price;
        capital = 0;
        lastSignal = 'BUY';
        logTrade(`üü¢ BUY at $${price.toFixed(4)}, Qty: ${qty.toFixed(2)}`);
        document.getElementById("signal").innerText = "üü¢ BUY Signal";
        sendEmail('BUY', price);
      } else if (price > resistance && lastSignal !== 'SELL' && position > 0) {
        const proceeds = position * price;
        capital = proceeds;
        position = 0;
        lastSignal = 'SELL';
        logTrade(`üî¥ SELL at $${price.toFixed(4)}, Capital: $${capital.toFixed(2)}`);
        document.getElementById("signal").innerText = "üî¥ SELL Signal";
        sendEmail('SELL', price);
      }
    }

    function sendEmail(signal, price) {
      const sent = localStorage.getItem(`sent-${signal}`);
      if (sent) return; // hanya kirim sekali
      emailjs.send("service_5hxo1hk", "template_iq87egh", {
        signal_type: signal,
        price: price.toFixed(4),
        timestamp: new Date().toLocaleString()
      }).then(() => {
        localStorage.setItem(`sent-${signal}`, 'true');
        logTrade(`üìß Email ${signal} terkirim.`);
      });
    }

    async function fetchPrice() {
      try {
        const res = await fetch("https://api.dexscreener.com/latest/dex/pairs/bsc/0xA39af17CE4a8Eb807e076805DA1E2B8EA7D0755b");
        const data = await res.json();
        const price = parseFloat(data.pair.priceUsd);

        document.getElementById("livePrice").innerText = `Live: $${price.toFixed(4)}`;
        pushNewCandle(price);
        chart.data.datasets[0].data = priceData;
        chart.update();
        evaluateSignal(price);
      } catch (e) {
        console.error("‚ùå Gagal fetch harga:", e);
      }
    }

    // Auto refresh setiap 30 detik
    setInterval(fetchPrice, 30000);
    fetchPrice(); // pertama kali langsung jalan
  </script>
</body>
</html>
