<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PancakeSwap Auto Bot — USDT↔CAKE</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; }
    #chart { width:100%; height:400px; }
    button { margin:5px; padding:10px; border-radius:8px; border:none; cursor:pointer; }
    .buy { background:#2ecc71; color:#fff; }
    .sell { background:#e74c3c; color:#fff; }
  </style>
</head>
<body>
  <h2>PancakeSwap Auto Bot — USDT ↔ CAKE</h2>
  <button onclick="connectWallet()">Connect TrustWallet/MetaMask</button>
  <button class="buy" onclick="manualBuy()">Manual BUY</button>
  <button class="sell" onclick="manualSell()">Manual SELL</button>
  <button onclick="toggleAuto()">Start/Stop Auto</button>
  <canvas id="chart"></canvas>
  <pre id="log"></pre>

<script>
const log = (msg) => {
  const ts = new Date().toLocaleTimeString();
  document.getElementById('log').textContent += `\n[${ts}] ${msg}`;
};

let provider;
let signer;
let router;
let auto = false;
let bars = [];

// Addresses (normalized with getAddress)
const USDT = ethers.getAddress("0x55d398326f99059fF775485246999027B3197955");
const CAKE = ethers.getAddress("0x0E09FABB73Bd3Ade0a17ECC321fD13a19e81cE82");
const ROUTER = ethers.getAddress("0x10ED43C718714eb63d5aA57B78B54704E256024E");

const routerAbi = [
  "function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint256[] memory amounts)",
  "function swapExactTokensForTokens(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) external returns (uint[] memory amounts)"
];

async function connectWallet(){
  if(window.trustwallet){
    provider = new ethers.BrowserProvider(window.trustwallet);
  } else if(window.ethereum){
    provider = new ethers.BrowserProvider(window.ethereum);
  } else {
    log("No wallet detected");
    return;
  }
  signer = await provider.getSigner();
  router = new ethers.Contract(ROUTER, routerAbi, signer);
  log("Wallet connected");
}

async function fetchPrice(){
  try{
    const contract = new ethers.Contract(ROUTER, routerAbi, provider);
    const amtIn = ethers.parseUnits("1", 18);
    const out = await contract.getAmountsOut(amtIn,[USDT,CAKE]);
    const price = Number(out[1]) / 1e18;
    return price;
  }catch(e){ log("Price error: "+e.message); return null; }
}

function updateBars(price){
  const now = Date.now();
  if(bars.length===0 || now - bars[bars.length-1].t > 60000){
    bars.push({t:now,o:price,h:price,l:price,c:price});
    if(bars.length>200) bars.shift();
  } else {
    let b = bars[bars.length-1];
    b.h = Math.max(b.h,price);
    b.l = Math.min(b.l,price);
    b.c = price;
  }
}

function calcLRC(){
  const n=100; if(bars.length<n) return null;
  let xs = bars.slice(-n).map((_,i)=>i);
  let ys = bars.slice(-n).map(b=>b.c);
  let xmean=xs.reduce((a,b)=>a+b)/n;
  let ymean=ys.reduce((a,b)=>a+b)/n;
  let num=0,den=0;
  for(let i=0;i<n;i++){ num+=(xs[i]-xmean)*(ys[i]-ymean); den+=(xs[i]-xmean)**2; }
  let slope=num/den; let intercept=ymean-slope*xmean;
  let mid = slope*(n-1)+intercept;
  let dev = Math.sqrt(ys.map(y=>(y-ymean)**2).reduce((a,b)=>a+b)/n);
  return {mid,upper:mid+2*dev,lower:mid-2*dev};
}

function calcUT(){
  if(bars.length<20) return null;
  let atrPeriod=1; let factor=10;
  let atr=0; for(let i=1;i<bars.length;i++) atr+=Math.abs(bars[i].c-bars[i-1].c);
  atr/=bars.length-1;
  let stop=bars[bars.length-1].c - factor*atr;
  return {signal: stop<bars[bars.length-1].c?"buy":"sell", stop};
}

async function autoLoop(){
  if(!auto) return;
  const p=await fetchPrice(); if(!p){setTimeout(autoLoop,5000);return;}
  updateBars(p);
  const lrc=calcLRC(); const ut=calcUT();
  if(lrc && ut){
    if(ut.signal==="buy" && p<=lrc.mid){ log(`AUTO BUY @ ${p}`); /* executeBuy() */ }
    if(ut.signal==="sell" || p>lrc.upper){ log(`AUTO SELL @ ${p}`); /* executeSell() */ }
  }
  drawChart();
  setTimeout(autoLoop,5000);
}

function toggleAuto(){ auto=!auto; if(auto){ log("Auto started"); autoLoop(); } else log("Auto stopped"); }

function manualBuy(){ log("Manual BUY clicked"); }
function manualSell(){ log("Manual SELL clicked"); }

// Chart
const ctx=document.getElementById('chart');
const chart=new Chart(ctx,{type:'candlestick',data:{datasets:[{label:'Price',data:[]}]} ,options:{}});

function drawChart(){
  const data=bars.map(b=>({x:new Date(b.t),o:b.o,h:b.h,l:b.l,c:b.c}));
  chart.data.datasets[0].data=data;
  chart.update();
}
</script>
</body>
</html>
