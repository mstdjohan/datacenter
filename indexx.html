<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CAKE/USDT Candlestick Auto Trading</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background-color: #f4f4f4;
    }
    canvas {
      background-color: white;
      border: 1px solid #ccc;
    }
    #log {
      max-height: 250px;
      overflow-y: auto;
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <h2>CAKE/USDT Auto Trading</h2>
  <div id="livePrice">Live: $0.0000</div>
  <canvas id="chart" width="800" height="400"></canvas>

  <h3>Log Transaksi</h3>
  <div id="log"></div>

  <script>
    emailjs.init("OGH12a8LlCboHPVz8");

    // Register chart types
    Chart.register(
      Chart.FinancialController,
      Chart.CandlestickController,
      Chart.OhlcController,
      Chart.elements.CandlestickElement,
      Chart.elements.OhlcElement,
      Chart.scales.TimeScale,
      Chart.scales.LinearScale
    );

    const chartCtx = document.getElementById("chart").getContext("2d");
    let priceData = [];
    let lastBuyPrice = null;
    let lastSignal = "";

    const chart = new Chart(chartCtx, {
      type: 'candlestick',
      data: {
        datasets: [{
          label: 'CAKE/USDT',
          data: [],
          borderColor: 'black',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'minute'
            },
            ticks: {
              source: 'auto'
            }
          },
          y: {
            beginAtZero: false
          }
        }
      }
    });

    function logTrade(text) {
      const time = new Date().toLocaleTimeString();
      const entry = `[${time}] ${text}`;
      const logEl = document.getElementById("log");
      logEl.innerHTML = entry + "<br>" + logEl.innerHTML;
    }

    function pushNewCandle(price) {
      const now = new Date();
      const last = priceData[priceData.length - 1];

      if (!last || now - last.t > 60000) {
        priceData.push({
          t: now,
          o: price,
          h: price,
          l: price,
          c: price
        });
      } else {
        last.h = Math.max(last.h, price);
        last.l = Math.min(last.l, price);
        last.c = price;
      }
    }

    function sendEmail(subject, body) {
      if (localStorage.getItem("lastSignal") === subject) return; // jangan kirim ulang
      localStorage.setItem("lastSignal", subject);
      emailjs.send("service_5hxo1hk", "template_iq87egh", {
        subject: subject,
        message: body
      }).then(() => {
        logTrade(`üìß Email terkirim: ${subject}`);
      }).catch(error => {
        logTrade(`‚ùå Gagal kirim email: ${error}`);
      });
    }

    function evaluateSignal(price) {
      const low24h = Math.min(...priceData.map(p => p.l));
      const high24h = Math.max(...priceData.map(p => p.h));

      const support = low24h + (high24h - low24h) * 0.15;
      const resistance = high24h - (high24h - low24h) * 0.15;

      if (price <= support && lastSignal !== "BUY") {
        lastBuyPrice = price;
        lastSignal = "BUY";
        logTrade(`‚úÖ BUY di $${price.toFixed(4)}`);
        sendEmail("Sinyal BUY", `Harga turun mendekati support: $${price}`);
      }

      if (price >= resistance && lastSignal === "BUY") {
        const profit = price - lastBuyPrice;
        lastSignal = "SELL";
        logTrade(`üí∞ SELL di $${price.toFixed(4)} (Profit: $${profit.toFixed(4)})`);
        sendEmail("Sinyal SELL", `Harga naik mendekati resistance: $${price} (Profit: $${profit.toFixed(4)})`);
      }
    }

    async function fetchPrice() {
      try {
        const res = await fetch("https://api.dexscreener.com/latest/dex/pairs/bsc/0xA39af17CE4a8Eb807e076805DA1E2B8EA7D0755b");
        const data = await res.json();
        const price = parseFloat(data.pairs?.[0]?.priceUsd || data.pair?.priceUsd || 0);

        if (!price) throw new Error("Harga tidak ditemukan di data API");

        document.getElementById("livePrice").innerText = `Live: $${price.toFixed(4)}`;
        pushNewCandle(price);
        chart.data.datasets[0].data = priceData;
        chart.update();
        evaluateSignal(price);
      } catch (e) {
        console.error("‚ùå Gagal fetch harga:", e);
        logTrade(`‚ùå Error ambil data: ${e.message}`);
      }
    }

    setInterval(fetchPrice, 30000);
    fetchPrice();
  </script>

</body>
</html>
