<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAKE/USDT — UT Bot + LR + Trailing + Email</title>

  <!-- Chart.js dan plugin candlestick -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@4.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#fff;color:#111;max-width:1100px;margin:20px auto;padding:12px}
    h1{font-size:18px;margin-bottom:10px}
    .row{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:10px}
    .card{background:#f5f7fa;border-radius:8px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,.08);flex:1}
    label{display:block;font-size:13px;margin-bottom:4px}
    input,select,button{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;font-size:13px}
    button{cursor:pointer;background:#0084ff;color:#fff;border:none}
    button:hover{opacity:.9}
    pre{background:#eee;padding:8px;border-radius:6px;font-size:12px}
    #chartWrap{height:460px}
  </style>
</head>
<body>
  <h1>CAKE/USDT — UT Bot (1,10) + Linear Regression (100,2) + Trailing (1.5%)</h1>

  <div class="row">
    <div class="card" style="flex-basis:300px">
      <label>Interval Binance</label>
      <select id="interval"><option value="15m" selected>15m</option><option value="1h">1h</option></select>
      <label style="margin-top:6px">Trailing stop (%)</label>
      <input id="trailingPct" type="number" value="1.5" step="0.01">
      <label style="margin-top:6px">UT Bot — factor / ATR period</label>
      <input id="utFactor" value="1" type="number">
      <input id="utAtrPeriod" value="10" type="number" style="margin-top:4px">
      <label style="margin-top:6px">Linear Regression — period / multiplier</label>
      <input id="lrPeriod" value="100" type="number">
      <input id="lrMult" value="2" type="number" style="margin-top:4px">
    </div>

    <div class="card" style="flex-basis:360px">
      <label>EmailJS (opsional)</label>
      <input id="emailUser" placeholder="user_xxx (default)" value="default_user">
      <input id="emailService" placeholder="service_xxx (default)" value="default_service" style="margin-top:4px">
      <input id="emailTemplate" placeholder="template_xxx (default)" value="default_template" style="margin-top:4px">
      <label style="margin-top:8px">Penerima Email</label>
      <input id="emailTo" placeholder="you@example.com">
      <label style="margin-top:8px">Pesan Email</label>
      <input id="emailMsgBuy" value="BUY {{pair}} at {{price}}" placeholder="Buy message">
      <input id="emailMsgSell" value="SELL {{pair}} at {{price}}" style="margin-top:4px" placeholder="Sell message">
    </div>

    <div class="card" style="flex-basis:240px">
      <label>Aksi</label>
      <button id="startBtn">Start</button>
      <button id="stopBtn" style="margin-top:6px;background:#555">Stop</button>
      <label style="margin-top:10px">Status</label>
      <pre id="status">idle</pre>
      <label>Last signal</label>
      <pre id="lastSignal">-</pre>
    </div>
  </div>

  <div id="chartWrap" class="card"><canvas id="chart"></canvas></div>

  <script>
    // Register plugin
    Chart.register(window['chartjs-chart-financial']);

    function sma(values, period){
      const out=[]; for(let i=0;i<values.length;i++){ if(i+1<period){out.push(null);continue} let sum=0;for(let j=0;j<period;j++)sum+=values[i-j];out.push(sum/period)} return out;
    }
    function atr(high,low,close,period){
      const tr=[];for(let i=0;i<close.length;i++){if(i===0)tr.push(high[i]-low[i]);else tr.push(Math.max(high[i]-low[i],Math.abs(high[i]-close[i-1]),Math.abs(low[i]-close[i-1])));}
      const out=[];let sum=0;for(let i=0;i<tr.length;i++){if(i<period){sum+=tr[i];if(i===period-1)out.push(sum/period);else out.push(null)}else{sum=sum-tr[i-period]+tr[i];out.push(sum/period)}}return out;
    }
    function linearRegression(values){const n=values.length;let sx=0,sy=0,sxy=0,sxx=0;for(let i=0;i<n;i++){sx+=i;sy+=values[i];sxy+=i*values[i];sxx+=i*i}const slope=(n*sxy-sx*sy)/(n*sxx-sx*sx);const intercept=(sy-slope*sx)/n;return{slope,intercept}}
    function lrChannel(close,period,mult){const mid=[],up=[],low=[];for(let i=0;i<close.length;i++){if(i+1<period){mid.push(null);up.push(null);low.push(null);continue}const w=close.slice(i+1-period,i+1);const lr=linearRegression(w);const n=w.length;let s=0;for(let j=0;j<n;j++){const p=lr.intercept+lr.slope*j;s+=(w[j]-p)**2}const std=Math.sqrt(s/n);const mv=lr.intercept+lr.slope*(n-1);mid.push(mv);up.push(mv+mult*std);low.push(mv-mult*std)}return{mid,up,low}}
    function utBot(close,high,low,atrP,factor){const a=atr(high,low,close,atrP);const lS=new Array(close.length).fill(null);const sS=new Array(close.length).fill(null);const t=new Array(close.length).fill(null);for(let i=0;i<close.length;i++){if(a[i]==null){t[i]=null;continue}const bL=(high[i]+low[i])/2-factor*a[i];const bS=(high[i]+low[i])/2+factor*a[i];if(i===0){lS[i]=bL;sS[i]=bS;t[i]=1;continue}lS[i]=Math.max(bL,lS[i-1]||bL);sS[i]=Math.min(bS,sS[i-1]||bS);if(close[i]>sS[i-1])t[i]=1;else if(close[i]<lS[i-1])t[i]=-1;else t[i]=t[i-1]||1;}return{atr:a,longStop:lS,shortStop:sS,trend:t}}

    async function fetchKlines(symbol,interval,limit=200){
      const url=`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
      const r=await fetch(url);const j=await r.json();return j.map(k=>({t:k[0],o:+k[1],h:+k[2],l:+k[3],c:+k[4]}));
    }

    function configureEmailJS(user){if(user && user!=='default_user') emailjs.init(user);}
    async function sendEmail(svc,tmp,to,msg){
      if(svc==='default_service'||tmp==='default_template')return;
      try{await emailjs.send(svc,tmp,{to_email:to,message:msg});}catch(e){console.error(e);}
    }

    const ctx=document.getElementById('chart');
    let chart=new Chart(ctx,{type:'candlestick',data:{datasets:[{label:'CAKE/USDT',data:[]}]}});
    let intervalId=null;let lastSig=null;

    async function updateChart(){
      const interval=document.getElementById('interval').value;
      const kl=await fetchKlines('CAKEUSDT',interval,300);
      const times=kl.map(k=>k.t),c=kl.map(k=>k.c),h=kl.map(k=>k.h),l=kl.map(k=>k.l);
      const ut=utBot(c,h,l,+utAtrPeriod.value,+utFactor.value);
      const lr=lrChannel(c,+lrPeriod.value,+lrMult.value);

      chart.data.datasets=[{
        label:'CAKE/USDT',data:kl.map(k=>({x:k.t,o:k.o,h:k.h,l:k.l,c:k.c})),borderColor:'#000'
      },{
        label:'LR Mid',data:lr.mid.map((v,i)=>v?{x:times[i],y:v}:null),type:'line',borderColor:'#007bff',borderWidth:1,pointRadius:0
      }];
      chart.update();

      const t=ut.trend;const i=t.length-1;
      if(i>1&&t[i]!=null&&t[i-1]!=null){
        if(t[i-1]<=0&&t[i]>0) handleSignal('BUY',c[i]);
        if(t[i-1]>=0&&t[i]<0) handleSignal('SELL',c[i]);
      }
    }

    const pos={active:false,side:null,price:0,trail:0};
    function handleSignal(sig,price){
      const trail=parseFloat(trailingPct.value)/100;
      const st=document.getElementById('status'),ls=document.getElementById('lastSignal');
      if(!pos.active){pos.active=true;pos.side=sig;pos.price=price;pos.trail=trail;}
      else{if((pos.side==='BUY'&&sig==='SELL')||(pos.side==='SELL'&&sig==='BUY')){pos.side=sig;pos.price=price;pos.trail=trail;}}
      ls.textContent=`${sig} @ ${price}`;st.textContent=`Signal ${sig}`;
      const u=emailUser.value,s=emailService.value,t=emailTemplate.value,to=emailTo.value;
      configureEmailJS(u);const msg=(sig==='BUY'?emailMsgBuy.value:emailMsgSell.value).replace('{{pair}}','CAKE/USDT').replace('{{price}}',price);sendEmail(s,t,to,msg);
    }

    document.getElementById('startBtn').onclick=()=>{if(intervalId)return;updateChart();intervalId=setInterval(updateChart,30*1000);status.textContent='running';}
    document.getElementById('stopBtn').onclick=()=>{if(intervalId)clearInterval(intervalId);intervalId=null;status.textContent='stopped';}
  </script>
</body>
</html>
