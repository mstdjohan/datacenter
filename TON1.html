<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UT Bot Alerts — HTML Clone TradingView</title>
  <style>
    body{font-family:Arial, sans-serif;background:#0f172a;color:#e6eef8;padding:16px}
    .card{background:#071020;padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.6)}
    label{display:block;margin-top:8px}
    input,select{width:100%;padding:6px;border-radius:6px;border:1px solid #1f2937;background:#0b1220;color:#e6eef8}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0ea5a1;color:#02111a;font-weight:700;cursor:pointer}
    #chartContainer{height:500px;margin-top:12px}
    .signal{display:inline-block;padding:6px 10px;border-radius:8px;margin:6px 4px;font-weight:600}
    .long{background:#064e3b;color:#b7f5dd}
    .short{background:#6b021a;color:#ffd5da}
    pre{white-space:pre-wrap;background:#021627;padding:8px;border-radius:8px;margin-top:10px;max-height:200px;overflow:auto}
  </style>
  <!-- Chart.js & Financial plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0/dist/chartjs-chart-financial.min.js"></script>
</head>
<body>
  <div class="card">
    <h2>UT Bot Alerts — HTML clone of Pine Script</h2>

    <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
      <div>
        <label>Key Value (a)</label>
        <input id="inputA" type="number" step="0.1" value="1">
      </div>
      <div>
        <label>ATR Period (c)</label>
        <input id="inputC" type="number" step="1" value="10">
      </div>
      <div>
        <label>Use Heikin Ashi</label>
        <select id="inputHA"><option value="false">False</option><option value="true">True</option></select>
      </div>
      <button id="btnRun">Run Demo</button>
    </div>

    <div id="chartContainer">
      <canvas id="chart"></canvas>
    </div>

    <div id="latestSignals"></div>
    <pre id="log"></pre>
  </div>

<script>
// ----------------- Helpers mirip Pine -----------------
function nz(x, y = 0) { return (x === null || x === undefined || isNaN(x)) ? y : x; }
function iff(cond, a, b) { return cond ? a : b; }

// EMA
function ema(values, length) {
  const k = 2 / (length + 1);
  let out = [], prev = values[0];
  out[0] = prev;
  for (let i = 1; i < values.length; i++) {
    prev = values[i] * k + prev * (1 - k);
    out[i] = prev;
  }
  return out;
}

// True Range & ATR (Wilder)
function trueRangeSeries(ohlc) {
  let tr = [];
  for (let i = 0; i < ohlc.length; i++) {
    if (i === 0) {
      tr.push(ohlc[i].high - ohlc[i].low);
    } else {
      let prevClose = ohlc[i - 1].close;
      tr.push(Math.max(
        ohlc[i].high - ohlc[i].low,
        Math.abs(ohlc[i].high - prevClose),
        Math.abs(ohlc[i].low - prevClose)
      ));
    }
  }
  return tr;
}
function atr(ohlc, period) {
  const tr = trueRangeSeries(ohlc);
  let atrArr = [], sum = 0;
  for (let i = 0; i < tr.length; i++) {
    if (i < period) {
      sum += tr[i];
      atrArr.push(i === period - 1 ? sum / period : null);
    } else {
      atrArr.push(((atrArr[i - 1]) * (period - 1) + tr[i]) / period);
    }
  }
  return atrArr;
}

// Heikin Ashi
function toHeikinAshi(ohlc) {
  let out = [];
  for (let i = 0; i < ohlc.length; i++) {
    let c = (ohlc[i].open + ohlc[i].high + ohlc[i].low + ohlc[i].close) / 4;
    let o = i === 0 ? (ohlc[i].open + ohlc[i].close) / 2 : (out[i - 1].open + out[i - 1].close) / 2;
    let h = Math.max(ohlc[i].high, o, c);
    let l = Math.min(ohlc[i].low, o, c);
    out.push({open:o, high:h, low:l, close:c, date:ohlc[i].date});
  }
  return out;
}

// UT Bot logic clone
function computeUT(ohlc, a, c, useHA) {
  const series = useHA ? toHeikinAshi(ohlc) : ohlc;
  const closes = series.map(d => d.close);
  const atrSeries = atr(series, c);
  const ema1 = ema(closes, 1);

  let xATRTrailingStop = [], pos = [], buy = [], sell = [];

  for (let i = 0; i < series.length; i++) {
    let src = series[i].close;
    let prevStop = nz(xATRTrailingStop[i - 1], 0);
    let prevSrc = i > 0 ? series[i - 1].close : src;
    let nLoss = a * nz(atrSeries[i], 0);

    let newStop;
    if (src > prevStop && prevSrc > prevStop) {
      newStop = Math.max(prevStop, src - nLoss);
    } else if (src < prevStop && prevSrc < prevStop) {
      newStop = Math.min(prevStop, src + nLoss);
    } else if (src > prevStop) {
      newStop = src - nLoss;
    } else {
      newStop = src + nLoss;
    }
    xATRTrailingStop.push(newStop);

    let newPos = nz(pos[i - 1], 0);
    if (prevSrc < prevStop && src > prevStop) newPos = 1;
    else if (prevSrc > prevStop && src < prevStop) newPos = -1;
    pos.push(newPos);

    let above = (ema1[i] > newStop && ema1[i - 1] <= xATRTrailingStop[i - 1]);
    let below = (newStop > ema1[i] && xATRTrailingStop[i - 1] <= ema1[i - 1]);

    buy.push(src > newStop && above);
    sell.push(src < newStop && below);
  }

  return series.map((d,i)=>({
    ...d, atr: atrSeries[i], stop: xATRTrailingStop[i],
    pos: pos[i], buy: buy[i], sell: sell[i]
  }));
}

// ----------------- Chart -----------------
let chart=null;
function renderChart(data) {
  const ctx = document.getElementById('chart').getContext('2d');
  const candles = data.map(d=>({t:new Date(d.date), o:d.open, h:d.high, l:d.low, c:d.close}));
  const stops = data.map(d=>({x:new Date(d.date), y:d.stop}));

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'candlestick',
    data:{datasets:[
      {label:'Price',data:candles,type:'candlestick'},
      {label:'Stop',data:stops,type:'line',borderColor:'#0ea5a1',fill:false,pointRadius:0}
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{x:{type:'time', distribution:'series'}, y:{position:'right'}}
    }
  });
}

// ----------------- Demo Data -----------------
function generateRandomOHLC(n) {
  let out=[], price=100;
  for(let i=0;i<n;i++){
    let date=new Date(); date.setMinutes(date.getMinutes()+i);
    let open=price;
    let change=(Math.random()-0.5)*2;
    let close=Math.max(0.1,open+change);
    let high=Math.max(open,close)+Math.random()*0.5;
    let low=Math.min(open,close)-Math.random()*0.5;
    out.push({date:date.toISOString(),open,high,low,close});
    price=close;
  }
  return out;
}

// ----------------- Run -----------------
document.getElementById('btnRun').addEventListener('click', ()=>{
  const ohlc=generateRandomOHLC(150);
  const a=parseFloat(document.getElementById('inputA').value);
  const c=parseInt(document.getElementById('inputC').value);
  const useHA=document.getElementById('inputHA').value==='true';

  const result=computeUT(ohlc,a,c,useHA);
  renderChart(result);

  let logLines=[];
  result.forEach(r=>{
    if(r.buy) logLines.push(`${r.date} BUY @ ${r.close.toFixed(4)}`);
    if(r.sell) logLines.push(`${r.date} SELL @ ${r.close.toFixed(4)}`);
  });
  document.getElementById('log').textContent=logLines.join("\\n") || "No signals.";
  const latest=result[result.length-1];
  document.getElementById('latestSignals').innerHTML=
    (latest.buy?'<span class=\"signal long\">Latest: BUY</span>':'')+
    (latest.sell?'<span class=\"signal short\">Latest: SELL</span>':'');
});

// auto run
document.getElementById('btnRun').click();
</script>
</body>
</html>
