<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Strategi Trading TON - "ton1"</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
    h2 { color: #1f2937; }
    canvas { background: #fff; border: 1px solid #ccc; }
    #log { margin-top: 20px; white-space: pre-line; font-family: monospace; background: #eef; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>üìä Harga TON "ton1" & Indikator (Real-time + Historis)</h2>
  <canvas id="chart" width="400" height="150"></canvas>
  <p id="price">üí∞ Harga Saat Ini: -</p>
  <p id="balance">üí∞ Modal: $1000.00</p>
  <div id="log">‚è≥ Memuat data...</div>

  <script>
    emailjs.init("OGH12a8LlCboHPVz8");

    const chartCtx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Harga', data: [], borderColor: 'blue', fill: false },
          { label: 'Upper BB', data: [], borderColor: 'green', borderDash: [5, 5], fill: false },
          { label: 'Lower BB', data: [], borderColor: 'red', borderDash: [5, 5], fill: false },
          { label: 'BUY', data: [], pointBackgroundColor: 'lime', showLine: false, pointRadius: 6, type: 'scatter' },
          { label: 'SELL', data: [], pointBackgroundColor: 'red', showLine: false, pointRadius: 6, type: 'scatter' }
        ]
      }
    });

    let balance = 1000;
    let lastSignal = localStorage.getItem("ton_last_signal") || "";

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      document.getElementById("log").textContent += `\n[${now}] ${msg}`;
    }

    function sendEmail(subject, message) {
      emailjs.send("service_5hxo1hk", "template_iq87egh", {
        subject,
        message,
      }).then(() => {
        log(`üìß Notifikasi email terkirim: ${subject}`);
      }).catch(() => {
        log(`‚ùå Gagal kirim email`);
      });
    }

    async function fetchHistoricalData() {
      try {
        const res = await fetch("https://api.coingecko.com/api/v3/coins/toncoin/market_chart?vs_currency=usd&days=1");
        const json = await res.json();
        return json.prices.map(p => ({ time: new Date(p[0]), price: p[1] }));
      } catch (err) {
        log("‚ùå Gagal ambil data historis TON dari CoinGecko");
        return [];
      }
    }

    function calculateBollinger(prices) {
      const period = 20;
      const result = { upper: [], lower: [], middle: [] };
      for (let i = 0; i < prices.length; i++) {
        if (i < period) {
          result.upper.push(null);
          result.lower.push(null);
          result.middle.push(null);
          continue;
        }
        const slice = prices.slice(i - period, i);
        const avg = slice.reduce((a, b) => a + b, 0) / period;
        const std = Math.sqrt(slice.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / period);
        result.middle.push(avg);
        result.upper.push(avg + 2 * std);
        result.lower.push(avg - 2 * std);
      }
      return result;
    }

    async function fetchLivePrice() {
      try {
        const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=toncoin&vs_currencies=usd");
        const data = await res.json();
        const price = parseFloat(data.toncoin.usd);
        document.getElementById("price").textContent = `üí∞ Harga Saat Ini: $${price.toFixed(4)}`;
        return price;
      } catch (err) {
        log("‚ùå Gagal ambil harga TON live");
        return null;
      }
    }

    async function updateChart() {
      const data = await fetchHistoricalData();
      if (!data.length) return;

      const prices = data.map(p => p.price);
      const timestamps = data.map(p => p.time.toLocaleTimeString());
      const bb = calculateBollinger(prices);

      chart.data.labels = timestamps;
      chart.data.datasets[0].data = prices;
      chart.data.datasets[1].data = bb.upper;
      chart.data.datasets[2].data = bb.lower;
      chart.update();
    }

    async function runStrategy() {
      const price = await fetchLivePrice();
      if (!price) return;

      const data = await fetchHistoricalData();
      const prices = data.map(p => p.price);
      const bb = calculateBollinger(prices);
      const lastBBUpper = bb.upper[bb.upper.length - 1];
      const lastBBLower = bb.lower[bb.lower.length - 1];

      const time = new Date().toLocaleTimeString();

      if (price <= lastBBLower && lastSignal !== "buy") {
        chart.data.datasets[3].data.push({ x: time, y: price });
        lastSignal = "buy";
        localStorage.setItem("ton_last_signal", "buy");
        log(`‚úÖ BUY di $${price.toFixed(4)} (Lower BB)`);
        sendEmail("BUY Signal", `Beli TON di $${price.toFixed(4)} (Lower BB)`);
      }

      if (price >= lastBBUpper && lastSignal !== "sell") {
        chart.data.datasets[4].data.push({ x: time, y: price });
        lastSignal = "sell";
        localStorage.setItem("ton_last_signal", "sell");
        log(`‚úÖ SELL di $${price.toFixed(4)} (Upper BB)`);
        sendEmail("SELL Signal", `Jual TON di $${price.toFixed(4)} (Upper BB)`);
      }

      chart.update();
    }

    async function start() {
      await updateChart();
      await runStrategy();
    }

    setInterval(start, 30000); // 30 detik
    start();
  </script>
</body>
</html>
