<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AutoTrade Frontend — Multi-coin Signal Tester</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap">
<style>
  :root{--bg:#0b1220;--card:#071827;--accent:#06b6d4;--muted:#9fb0c6}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#eaf6ff}
  header{padding:14px 18px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#071226,#061529)}
  header h1{font-size:16px;margin:0}
  .container{display:grid;grid-template-columns:1fr 420px;gap:12px;padding:14px}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 22px rgba(0,0,0,0.6)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,textarea,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071923;color:#eaf6ff;width:100%}
  textarea{min-height:120px;resize:vertical}
  .row{display:flex;gap:8px}
  .btn{background:var(--accent);color:#042a2f;border:none;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
  .log{height:220px;overflow:auto;background:#06121a;padding:10px;border-radius:8px;font-family:monospace;font-size:13px;color:#d7f6ff}
  .status-buy{color:#a6ffcc;font-weight:700}
  .status-sell{color:#ff9aa2;font-weight:700}
  .status-neutral{color:#cbd5e1;font-weight:600}
  footer{padding:12px;text-align:center;color:var(--muted)}
  @media(max-width:980px){.container{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>AutoTrade Frontend — Multi-coin Signal Tester</h1>
  <div class="small">Frontend untuk menguji TradingView → Webhook → Backend (Binance)</div>
</header>

<main class="container">
  <!-- LEFT: Controls + Results -->
  <section class="card">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <strong>Signal Request / Coin Selection</strong>
      <div class="small">Backend harus support POST /signal</div>
    </div>

    <label>Backend API Base URL (ex: http://localhost:5000/)</label>
    <input id="backendUrl" placeholder="http://localhost:5000/" />

    <label>Webhook URL (opsional) - untuk tes POST ke webhook endpoint</label>
    <input id="webhookUrl" placeholder="https://your-server.com/webhook" />

    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1">
        <label>Secret (x-tv-secret)</label>
        <input id="tvSecret" placeholder="my_pre_shared_secret_here" />
      </div>
      <div style="width:140px">
        <label>Timeframe</label>
        <select id="timeframe">
          <option value="1h">1h</option>
          <option value="4h">4h</option>
          <option value="1d">1d</option>
          <option value="15m">15m</option>
        </select>
      </div>
    </div>

    <label style="margin-top:10px">Masukkan daftar coin (satu per baris) — contoh: CAKEUSDT</label>
    <textarea id="coinsInput" placeholder="CAKEUSDT\nBNBUSDT\nBTCUSDT" ></textarea>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnFetch" class="btn">Fetch Signals</button>
      <button id="btnClear" style="background:#2a3946;color:#eaf6ff;border:none">Clear Results</button>
      <button id="btnLoadSample" style="background:#16384a;color:#eaf6ff;border:none">Load Sample</button>
    </div>

    <div style="margin-top:12px">
      <strong>Results</strong>
      <table id="resultsTable" aria-live="polite">
        <thead><tr><th>Coin</th><th>Signal</th><th>Price</th><th>Timestamp</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:12px">
      <strong>Send Test Webhook</strong>
      <div class="small">Mengirim payload yang mirip TradingView ke Webhook URL di atas</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="testQty" placeholder="qty (ex: 0.01)" style="flex:1" />
        <select id="testAction" style="width:120px">
          <option>BUY</option>
          <option>SELL</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="testCoin" placeholder="Symbol for test (ex: CAKEUSDT)" style="flex:1" />
        <button id="btnSendWebhook" class="btn" style="width:160px">Send Webhook</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <strong>Logs</strong>
      <div id="log" class="log"></div>
    </div>
  </section>

  <!-- RIGHT: Utilities -->
  <aside class="card">
    <strong>Utilities</strong>
    <div style="margin-top:8px">
      <label>Fetch Market Price (Binance public API)</label>
      <div style="display:flex;gap:8px">
        <input id="priceSymbol" placeholder="ex: CAKEUSDT" />
        <button id="btnFetchPrice" class="btn" style="width:120px">Fetch Price</button>
      </div>
      <div id="priceResult" class="small" style="margin-top:6px"></div>
    </div>

    <div style="margin-top:12px">
      <label>Convert budget (USDT) → qty</label>
      <div style="display:flex;gap:8px">
        <input id="budgetSymbol" placeholder="symbol ex: CAKEUSDT" />
        <input id="budgetValue" placeholder="USDT amount ex: 5" />
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnConvert" class="btn">Convert</button>
        <button id="btnCopy" style="background:#2a3946;color:#eaf6ff;border:none">Copy qty</button>
      </div>
      <div id="convertRes" class="small" style="margin-top:6px"></div>
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

    <div>
      <strong>Settings</strong>
      <div class="small" style="margin-top:6px">Save / Load settings to browser</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnSave" class="btn" style="flex:1">Save Settings</button>
        <button id="btnLoad" style="background:#2a3946;color:#eaf6ff;border:none;flex:1">Load Settings</button>
      </div>
      <div style="margin-top:8px">
        <button id="btnOpenTv" style="width:100%" class="btn">Open TradingView (symbol)</button>
      </div>
    </div>

  </aside>
</main>

<footer class="small card">
  Cara pakai singkat: jalankan backend (Flask) → isi Backend URL → masukkan coin list → tekan Fetch Signals.  
  Jika melihat CORS errors, jalankan frontend via `python -m http.server` atau aktifkan CORS di backend.
</footer>

<script>
(function(){
  // helpers
  const el = id => document.getElementById(id);
  const logEl = el('log');

  function log(msg, obj){
    const t = new Date().toLocaleTimeString();
    const line = document.createElement('div');
    line.textContent = `[${t}] ${msg}` + (obj ? ' ' + JSON.stringify(obj) : '');
    logEl.prepend(line);
  }

  // Save / Load settings
  el('btnSave').addEventListener('click', ()=>{
    const s = {
      backendUrl: el('backendUrl').value.trim(),
      webhookUrl: el('webhookUrl').value.trim(),
      tvSecret: el('tvSecret').value.trim(),
      coins: el('coinsInput').value.trim(),
      timeframe: el('timeframe').value
    };
    localStorage.setItem('autotrade_settings', JSON.stringify(s));
    log('Settings saved');
    alert('Saved');
  });
  el('btnLoad').addEventListener('click', ()=>{
    const raw = localStorage.getItem('autotrade_settings');
    if(!raw){ alert('No saved settings'); return; }
    const s = JSON.parse(raw);
    el('backendUrl').value = s.backendUrl || '';
    el('webhookUrl').value = s.webhookUrl || '';
    el('tvSecret').value = s.tvSecret || '';
    el('coinsInput').value = s.coins || '';
    el('timeframe').value = s.timeframe || '1h';
    log('Settings loaded');
  });

  el('btnLoadSample').addEventListener('click', ()=>{
    el('coinsInput').value = 'CAKEUSDT\nBNBUSDT\nBTCUSDT\nETHUSDT';
  });

  // Fetch signals from backend
  el('btnFetch').addEventListener('click', async ()=>{
    const backend = (el('backendUrl').value || '').trim();
    if(!backend){ alert('Masukkan Backend URL'); return; }
    const base = backend.endsWith('/') ? backend : backend + '/';
    const url = base + 'signal';
    const coins = el('coinsInput').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(coins.length === 0){ alert('Masukkan minimal 1 coin'); return; }
    const timeframe = el('timeframe').value;
    log('Fetching signals', {url, coins, timeframe});
    try{
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ coins, timeframe, limit:200 })
      });
      if(!resp.ok){
        const txt = await resp.text();
        log('Backend error', {status: resp.status, text: txt});
        alert('Backend error: ' + resp.status);
        return;
      }
      const data = await resp.json();
      log('Signals received', data);
      renderResults(data);
    }catch(err){
      log('Fetch error', err.message || err);
      alert('Fetch failed: ' + (err.message || err));
    }
  });

  function renderResults(data){
    const tbody = el('resultsTable').querySelector('tbody');
    tbody.innerHTML = '';
    for(const k of Object.keys(data)){
      const row = data[k];
      const tr = document.createElement('tr');
      const tdSymbol = document.createElement('td');
      tdSymbol.textContent = k;
      const tdSignal = document.createElement('td');
      const sig = row.signal || row.error || 'N/A';
      tdSignal.textContent = sig;
      if(sig === 'BUY') tdSignal.className = 'status-buy';
      if(sig === 'SELL') tdSignal.className = 'status-sell';
      if(sig === 'NEUTRAL') tdSignal.className = 'status-neutral';
      const tdPrice = document.createElement('td');
      tdPrice.textContent = row.last_price ? Number(row.last_price).toFixed(6) : '-';
      const tdTs = document.createElement('td');
      tdTs.textContent = row.timestamp || '-';
      tr.appendChild(tdSymbol);
      tr.appendChild(tdSignal);
      tr.appendChild(tdPrice);
      tr.appendChild(tdTs);
      tbody.appendChild(tr);
    }
  }

  // Fetch price
  el('btnFetchPrice').addEventListener('click', async ()=>{
    const s = (el('priceSymbol').value || '').trim().toUpperCase();
    if(!s) { alert('Masukkan symbol'); return; }
    try{
      el('priceResult').textContent = 'Fetching...';
      const resp = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${s}`);
      if(!resp.ok) throw new Error('Symbol not found');
      const j = await resp.json();
      el('priceResult').textContent = `${s} price = ${j.price}`;
      log('Price fetched', j);
    }catch(err){
      el('priceResult').textContent = 'Error: ' + (err.message || err);
      log('Price fetch error', err.message || err);
    }
  });

  // Convert budget to qty
  el('btnConvert').addEventListener('click', async ()=>{
    const s = (el('budgetSymbol').value || '').trim().toUpperCase();
    const b = Number(el('budgetValue').value || 0);
    if(!s || !b){ alert('Masukkan symbol dan USDT budget'); return; }
    el('convertRes').textContent = 'Computing...';
    try{
      const resp = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${s}`);
      if(!resp.ok) throw new Error('Symbol not found');
      const j = await resp.json();
      const price = Number(j.price);
      const qty = Number((b / price).toFixed(8));
      el('convertRes').textContent = `qty ≈ ${qty} @ ${price} USDT`;
      log('Budget converted', {symbol:s, budget:b, qty, price});
    }catch(err){
      el('convertRes').textContent = 'Error: ' + (err.message || err);
      log('Convert error', err.message || err);
    }
  });

  el('btnCopy').addEventListener('click', ()=>{
    const text = el('convertRes').textContent || '';
    navigator.clipboard.writeText(text).then(()=>log('Copied to clipboard')).catch(e=>log('Copy failed', e));
  });

  // Send test webhook
  el('btnSendWebhook').addEventListener('click', async ()=>{
    const webhook = (el('webhookUrl').value || '').trim();
    if(!webhook){ alert('Masukkan Webhook URL'); return; }
    const action = el('testAction').value;
    const symbol = (el('testCoin').value || '').trim().toUpperCase();
    const qtyRaw = Number(el('testQty').value || 0);
    if(!symbol || !qtyRaw){ alert('Isi symbol dan qty'); return; }
    const payload = {
      tv_secret: el('tvSecret').value.trim() || undefined,
      action,
      symbol,
      qty: qtyRaw,
      type: 'MARKET',
      alert_id: 'manual-webhook-' + Date.now(),
      comment: 'Sent from frontend test'
    };
    log('Sending webhook', {webhook, payload});
    try{
      const headers = {'Content-Type':'application/json'};
      // prefer header secret if provided
      const secret = el('tvSecret').value.trim();
      if(secret) headers['x-tv-secret'] = secret;
      const resp = await fetch(webhook, { method:'POST', headers, body: JSON.stringify(payload) });
      const text = await resp.text();
      log('Webhook response', {status: resp.status, text});
      alert('Webhook sent. See logs.');
    }catch(err){
      log('Webhook error', err.message || err);
      alert('Webhook failed: ' + (err.message || err));
    }
  });

  // Open TradingView for symbol
  el('btnOpenTv').addEventListener('click', ()=>{
    const s = (el('priceSymbol').value || el('coinsInput').value.split(/\\r?\\n/)[0] || 'CAKEUSDT').trim().toUpperCase();
    const url = `https://www.tradingview.com/chart/?symbol=BINANCE%3A${encodeURIComponent(s)}`;
    window.open(url, '_blank');
  });

  // Clear results
  el('btnClear').addEventListener('click', ()=>{
    el('resultsTable').querySelector('tbody').innerHTML = '';
    log('Results cleared');
  });

  // Save settings on change automatically
  ['backendUrl','webhookUrl','tvSecret','timeframe','coinsInput'].forEach(id=>{
    el(id).addEventListener('change', ()=> {
      // Auto-save small
      const raw = localStorage.getItem('autotrade_settings') || '{}';
      const s = JSON.parse(raw);
      s[id] = el(id).value;
      localStorage.setItem('autotrade_settings', JSON.stringify(s));
    });
  });

  // Auto-load existing settings
  (function autoLoad(){
    const raw = localStorage.getItem('autotrade_settings');
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      for(const k in s) if(el(k)) el(k).value = s[k];
      log('Loaded saved settings');
    }catch(e){}
  })();

})();
</script>
</body>
</html>
