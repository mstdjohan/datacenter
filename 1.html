<!DOCTYPE html>
<html>
<head>
  <title>CAKE Signal Indodax</title>
</head>
<body>
  <h2>Signal Trading CAKE di Indodax</h2>
  <div id="status">Loading...</div>
  <div id="signal">Waiting signal...</div>

  <script>
    let prices = [];
    let pair = null; // nanti diisi otomatis

    async function findPair() {
      try {
        let res = await fetch("https://indodax.com/api/pairs");
        let data = await res.json();

        // cari pair yang ada kata 'cake'
        let found = data.find(p => p.id.includes("cake"));
        if (found) {
          pair = found.id;
          document.getElementById("status").innerText = "Pair ditemukan: " + pair;
        } else {
          throw new Error("Pair CAKE tidak tersedia di Indodax");
        }
      } catch (err) {
        document.getElementById("status").innerText = "Error: " + err;
      }
    }

    async function getPrice() {
      if (!pair) return;
      try {
        let res = await fetch(`https://indodax.com/api/ticker/${pair}`);
        let data = await res.json();

        if (!data.ticker || !data.ticker.last) {
          throw new Error("Invalid response: " + JSON.stringify(data));
        }

        let price = parseFloat(data.ticker.last);
        prices.push(price);
        if (prices.length > 100) prices.shift();

        document.getElementById("status").innerText = "Last Price " + price + " (" + pair + ")";

        if (prices.length >= 20) {
          let avg = prices.reduce((a, b) => a + b, 0) / prices.length;
          let variance = prices.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / prices.length;
          let stdev = Math.sqrt(variance);
          let upper = avg + 2 * stdev;
          let lower = avg - 2 * stdev;

          let signal = "HOLD";
          if (price > upper) {
            signal = "SELL ðŸš¨";
          } else if (price < lower) {
            signal = "BUY âœ…";
          }

          document.getElementById("signal").innerText = "Signal: " + signal;
        }

      } catch (err) {
        document.getElementById("status").innerText = "Error: " + err;
      }
    }

    // jalankan
    (async () => {
      await findPair();         // cari dulu pair yang sah
      setInterval(getPrice, 5000); // ambil harga setiap 5 detik
    })();
  </script>
</body>
</html>
