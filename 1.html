<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UT-Bot Live Chart (Binance)</title>
  <style>
    :root{--bg:#0b1220;--card:#071826;--muted:#9fb0c6;--accent:#06b6d4}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#eaf6ff}
    header{padding:10px 14px;background:linear-gradient(90deg,#061226,#071829);display:flex;justify-content:space-between;align-items:center}
    header h1{font-size:15px;margin:0}
    .wrap{display:flex;gap:12px;padding:12px;flex-direction:column}
    .top{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select,button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071927;color:#eaf6ff}
    button{background:var(--accent);color:#042a2f;border:none;cursor:pointer}
    #chartHolder{width:100%;max-width:1200px;height:520px;background:#07121a;border-radius:8px;overflow:hidden;margin-top:10px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .log{margin-top:10px;background:#06121a;padding:8px;border-radius:8px;font-family:monospace;height:140px;overflow:auto;font-size:13px}
    .small{color:var(--muted);font-size:13px}
    @media(min-width:980px){ .wrap{max-width:1200px;margin:0 auto} }
  </style>
  <!-- lightweight-charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <header>
    <h1>UT-Bot Live Chart (Binance)</h1>
    <div class="small">Pilih simbol & timeframe â†’ klik Load</div>
  </header>

  <main class="wrap">
    <div class="top">
      <div class="controls">
        <label class="small" for="symbol">Symbol</label>
        <input id="symbol" value="CAKEUSDT" style="width:150px" />
        <label class="small" for="interval">Timeframe</label>
        <select id="interval">
          <option value="1m">1m</option>
          <option value="3m">3m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
          <option value="30m">30m</option>
          <option value="1h">1h</option>
          <option value="4h">4h</option>
          <option value="1d">1d</option>
        </select>

        <label class="small" for="limit">Candles</label>
        <input id="limit" type="number" min="50" max="1000" value="500" style="width:90px" />

        <button id="btnLoad">Load</button>
        <button id="btnReload" disabled>Reload</button>
        <button id="btnDebug">Show Console</button>
      </div>
    </div>

    <div id="chartHolder"></div>
    <div class="log" id="log"></div>
  </main>

<script>
(async function(){
  const $ = id => document.getElementById(id);
  const logEl = $('log');
  function log(msg, obj){
    const t = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.textContent = `[${t}] ${msg}` + (obj ? ' ' + JSON.stringify(obj) : '');
    logEl.prepend(div);
    // keep log short
    while(logEl.childNodes.length > 300) logEl.removeChild(logEl.lastChild);
    console.log(msg, obj || '');
  }

  // Create chart
  const holder = $('chartHolder');
  let chart = LightweightCharts.createChart(holder, {
    layout: { backgroundColor: '#07121a', textColor: '#e6eef8' },
    rightPriceScale: { borderColor: 'rgba(255,255,255,0.06)' },
    timeScale: { borderColor: 'rgba(255,255,255,0.06)', timeVisible:true }
  });
  const candleSeries = chart.addCandlestickSeries({
    upColor: '#26a69a', downColor: '#ef5350', wickUpColor: '#26a69a', wickDownColor: '#ef5350', borderVisible: false
  });

  window.addEventListener('resize', ()=> chart.applyOptions({ width: holder.clientWidth }));

  async function fetchKlines(symbol, interval, limit=500){
    symbol = symbol.toUpperCase();
    const url = `https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}`;
    log('Fetching klines', {url});
    const r = await fetch(url);
    if(!r.ok){
      const t = await r.text();
      throw new Error('Fetch klines failed: ' + r.status + ' ' + t);
    }
    const data = await r.json();
    // map to lightweight format
    return data.map(d => ({
      time: Math.floor(d[0]/1000),
      open: Number(d[1]),
      high: Number(d[2]),
      low: Number(d[3]),
      close: Number(d[4])
    }));
  }

  // UT Bot simple flip logic (ATR-like)
  function computeSignals(ohlc, atrLen=14, mult=3){
    const n = ohlc.length;
    if(n < atrLen + 5) return Array(n).fill(null);
    const tr = new Array(n).fill(0);
    for(let i=1;i<n;i++){
      tr[i] = Math.max(
        ohlc[i].high - ohlc[i].low,
        Math.abs(ohlc[i].high - ohlc[i-1].close),
        Math.abs(ohlc[i].low - ohlc[i-1].close)
      );
    }
    const atr = new Array(n).fill(null);
    let sum=0; for(let i=1;i<=atrLen;i++) sum+=tr[i];
    atr[atrLen] = sum/atrLen;
    for(let i=atrLen+1;i<n;i++) atr[i] = ((atr[i-1]*(atrLen-1))+tr[i]) / atrLen;

    const upper = new Array(n).fill(null), lower = new Array(n).fill(null), trend = new Array(n).fill(1), sig = new Array(n).fill(null);
    for(let i=atrLen;i<n;i++){
      const hl2 = (ohlc[i].high + ohlc[i].low) / 2;
      upper[i] = hl2 + mult*atr[i];
      lower[i] = hl2 - mult*atr[i];
    }

    // initial trend by comparing last close to last bands
    for(let i=atrLen+1;i<n;i++){
      const c = ohlc[i].close;
      const prev = i-1;
      // flip rules: if price closes above prev upper -> up; below prev lower -> down
      if(c > upper[prev]) trend[i] = 1;
      else if(c < lower[prev]) trend[i] = -1;
      else trend[i] = trend[prev] || 1;

      if(trend[i] !== trend[prev]){
        sig[i] = trend[i] === 1 ? 'BUY' : 'SELL';
      }
    }
    return sig;
  }

  function drawMarkers(ohlc, signals){
    const markers = [];
    for(let i=0;i<signals.length;i++){
      const s = signals[i];
      if(!s) continue;
      if(s === 'BUY') markers.push({ time: ohlc[i].time, position:'belowBar', color:'#00d28a', shape:'arrowUp', text:'BUY' });
      if(s === 'SELL') markers.push({ time: ohlc[i].time, position:'aboveBar', color:'#ff6b6b', shape:'arrowDown', text:'SELL' });
    }
    candleSeries.setMarkers(markers);
  }

  // main load
  async function loadChart(){
    try{
      $('btnReload').disabled = true;
      const symbol = $('symbol').value.trim() || 'CAKEUSDT';
      const interval = $('interval').value || '1m';
      const limit = Math.max(50, Math.min(1000, Number($('limit').value) || 500));
      log('Loading chart', {symbol, interval, limit});
      const klines = await fetchKlines(symbol, interval, limit);
      candleSeries.setData(klines);
      // compute & draw signals
      const sig = computeSignals(klines, 14, 3);
      drawMarkers(klines, sig);
      log('Chart drawn; latest signal: ' + (sig[sig.length-1] || 'none'));
      $('btnReload').disabled = false;
    }catch(err){
      log('Error loading chart: ' + (err.message || err));
      alert('Error: ' + (err.message || err));
      $('btnReload').disabled = false;
    }
  }

  // events
  $('btnLoad').addEventListener('click', loadChart);
  $('btnReload').addEventListener('click', loadChart);
  $('btnDebug').addEventListener('click', ()=> { alert('Open browser console (DevTools) to see errors/logs on desktop. On Android use remote debugging.'); });

  // try initial load (wait a tiny bit for layout)
  setTimeout(loadChart, 200);

  // Expose for debugging
  window._utbot = { loadChart, computeSignals, fetchKlines };
})();
</script>
</body>
</html>
