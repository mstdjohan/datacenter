<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UT Bot (2,10) + LRC (100,2,2) • CAKE/USDT • EmailJS Alerts</title>

<!-- Ethers (optional, hanya untuk connect wallet) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<!-- WalletConnect v2 UMD (optional) -->
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.1/dist/index.umd.min.js"></script>
<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
:root{--bg:#0b0f14;--panel:#0f1720;--muted:#8aa0b6;--text:#e6eef7;--accent:#38bdf8;--ok:#22c55e;--bad:#ef4444}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--panel);border-bottom:1px solid #1e293b}
h1{font-size:18px;margin:0}
.wrap{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px}
.card{background:var(--panel);border:1px solid #1e293b;border-radius:14px;padding:12px}
label{font-size:12px;color:var(--muted)} input,select,button{background:#09111e;color:var(--text);border:1px solid #213047;border-radius:12px;padding:8px 10px;font-size:13px}
button{cursor:pointer} button.primary{background:var(--accent);color:#001018;border:none}
.badge{padding:3px 8px;border-radius:999px;background:#0b1220;border:1px solid #213047;color:#a7c7de;font-size:11px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
#log{height:260px;overflow:auto;font-family:ui-monospace,Menlo,monospace;background:#0a0f18;border-radius:12px;padding:10px}
.muted{color:var(--muted)} .ok{color:var(--ok)} .bad{color:var(--bad)}
@media(max-width:1100px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>UT Bot (2,10) + LRC (100,2,2) • CAKE/USDT</h1>
  <div class="row">
    <span class="badge" id="status">Idle</span>
    <button class="primary" id="btnToggle">Start</button>
  </div>
</header>

<div class="wrap">
  <aside class="card">
    <h3 style="margin:0 0 6px">Sumber Data (Binance)</h3>
    <div class="grid">
      <div>
        <label>Symbol</label>
        <input id="symbol" value="CAKEUSDT">
      </div>
      <div>
        <label>Interval</label>
        <select id="interval">
          <option value="1m">1m</option>
          <option value="3m">3m</option>
          <option value="5m" selected>5m</option>
          <option value="15m">15m</option>
          <option value="1h">1h</option>
        </select>
      </div>
      <div>
        <label>Candles</label>
        <input id="limit" type="number" value="500">
      </div>
      <div>
        <label>Harga live</label>
        <span class="badge" id="live">-</span>
      </div>
    </div>

    <h3 class="muted" style="margin:10px 0 6px">UT Bot (2,10)</h3>
    <div class="row">
      <label>KV</label><input id="kv" type="number" value="2" step="0.1" style="width:80px">
      <label>ATR</label><input id="atr" type="number" value="10" step="1" style="width:80px">
    </div>

    <h3 class="muted" style="margin:10px 0 6px">Linear Regression Channel</h3>
    <div class="row">
      <label>Len</label><input id="lrLen" type="number" value="100" style="width:80px">
      <label>DevUp</label><input id="devUp" type="number" value="2" step="0.1" style="width:80px">
      <label>DevDn</label><input id="devDn" type="number" value="2" step="0.1" style="width:80px">
    </div>

    <h3 class="muted" style="margin:10px 0 6px">EmailJS</h3>
    <div class="grid">
      <input id="emailService" placeholder="service_xxx">
      <input id="emailTemplate" placeholder="template_xxx">
      <input id="emailUser" placeholder="public_xxx">
      <input id="emailTo" placeholder="tujuan@domain.com">
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnInitEmail">Init EmailJS</button>
      <span id="emailBadge" class="badge">EmailJS: Not set</span>
      <button id="btnTestEmail">Test</button>
    </div>

    <h3 class="muted" style="margin:10px 0 6px">Wallet (opsional)</h3>
    <div class="row">
      <input id="wcProjectId" placeholder="WalletConnect Project ID (untuk Trust Wallet)" style="width:240px">
      <button id="btnConnect">Connect</button>
      <span id="acct" class="badge">–</span>
    </div>
  </aside>

  <main class="card">
    <div class="row" style="justify-content:space-between">
      <div><b>Signal:</b> <span id="sig" class="badge">-</span></div>
      <div class="muted"><span id="lastUpdate">-</span></div>
    </div>
    <div id="log" class="card" style="margin-top:12px"></div>
  </main>
</div>

<script>
/* ===== Helpers UI ===== */
const $ = id => document.getElementById(id);
function log(msg){ const el=$("log"); el.innerHTML = `[${new Date().toLocaleString()}] ${msg}<br>` + el.innerHTML; }
function setStatus(s){ $("status").textContent = s; }

/* ===== State ===== */
const state = {
  running:false, timer:null,
  lastTrend:null, lastAlertBar:null,
  email:{service:"", template:"", user:"", to:""},
  wallet:{ provider:null, ethers:null, signer:null, account:null }
};

/* ===== EmailJS ===== */
function updateEmailBadge(){
  const ok = state.email.service && state.email.template && state.email.user;
  $("emailBadge").textContent = ok ? "EmailJS: Ready" : "EmailJS: Not set";
}
$("btnInitEmail").onclick = () => {
  state.email.service = $("emailService").value.trim();
  state.email.template = $("emailTemplate").value.trim();
  state.email.user     = $("emailUser").value.trim();
  state.email.to       = $("emailTo").value.trim();
  try{
    if(!window.emailjs) throw new Error("emailjs SDK belum termuat");
    if(state.email.user) window.emailjs.init(state.email.user);
    localStorage.setItem("email_cfg", JSON.stringify(state.email));
    updateEmailBadge();
    log("EmailJS diinisialisasi");
  }catch(e){ log("EmailJS init gagal: "+(e.message||e)); }
};
$("btnTestEmail").onclick = async () => {
  try {
    if(!(state.email.service && state.email.template && state.email.user)) { log("Isi EmailJS dulu"); return; }
    await emailjs.send(state.email.service, state.email.template, {
      signal:"TEST", symbol:$("symbol").value.trim(), price:"-", time:new Date().toLocaleString(), to: state.email.to
    });
    log("EmailJS test terkirim");
  } catch(e){ log("EmailJS test gagal: "+(e.text||e.message||e)); }
};
// load saved
(function(){ try{ const x=JSON.parse(localStorage.getItem("email_cfg")||"{}"); Object.assign(state.email,x);
  $("emailService").value=x.service||""; $("emailTemplate").value=x.template||""; $("emailUser").value=x.user||""; $("emailTo").value=x.to||"";
  if(x.user && window.emailjs) window.emailjs.init(x.user); updateEmailBadge();
}catch(_){} })();

/* ===== Wallet (opsional) ===== */
$("btnConnect").onclick = async () => {
  try{
    // MetaMask?
    if (window.ethereum && window.ethereum.isMetaMask){
      state.wallet.provider = window.ethereum;
      await state.wallet.provider.request({method:"eth_requestAccounts"});
      state.wallet.ethers = new ethers.providers.Web3Provider(state.wallet.provider);
      state.wallet.signer = state.wallet.ethers.getSigner();
      state.wallet.account = await state.wallet.signer.getAddress();
    } else {
      // Trust Wallet via WalletConnect v2
      const pid = $("wcProjectId").value.trim();
      if(!pid) { alert("Masukkan WalletConnect Project ID untuk Trust Wallet"); return; }
      const WC = window.WalletConnectEthereumProvider;
      if(!WC){ throw new Error("WalletConnect provider belum termuat"); }
      const wcProv = await WC.init({
        projectId: pid,
        chains:[56],
        methods:["eth_sendTransaction","eth_signTransaction","eth_sign","personal_sign","eth_signTypedData"],
        showQrModal:true
      });
      await wcProv.enable();
      state.wallet.provider = wcProv;
      state.wallet.ethers = new ethers.providers.Web3Provider(wcProv);
      state.wallet.signer = state.wallet.ethers.getSigner();
      state.wallet.account = await state.wallet.signer.getAddress();
    }
    $("acct").textContent = state.wallet.account;
    log("Wallet terhubung: "+state.wallet.account);
  }catch(e){ log("Gagal connect: "+(e.message||e)); }
};

/* ===== Data: Binance Klines (stabil & CORS-friendly) ===== */
const tfMap = { '1m':'1m','3m':'3m','5m':'5m','15m':'15m','1h':'1h' };
async function getKlines(symbol, interval, limit){
  const url = `https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(symbol)}&interval=${tfMap[interval]||'5m'}&limit=${limit||500}`;
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error("HTTP "+r.status);
  const arr = await r.json();
  // Binance kline: [openTime, open, high, low, close, volume, closeTime, ...]
  return arr.map(k=>({
    time: Math.floor(k[6]/1000),
    open: +k[1], high:+k[2], low:+k[3], close:+k[4], volume:+k[5]
  }));
}
async function getLastPrice(symbol){
  const r = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${encodeURIComponent(symbol)}`, {cache:'no-store'});
  if(!r.ok) return null; const j=await r.json(); return +j.price;
}

/* ===== Indicators: ATR, UT Bot, LRC ===== */
function trueRange(c){const t=[NaN];for(let i=1;i<c.length;i++){const a=c[i],b=c[i-1];t.push(Math.max(a.high-a.low,Math.abs(a.high-b.close),Math.abs(a.low-b.close)));}return t}
function atr(c,p=10){const t=trueRange(c),o=new Array(c.length).fill(NaN);let s=0,i=1;while(i<=p&&i<t.length){s+=t[i];i++}if(i<=p)return o;o[p]=s/p;for(let j=p+1;j<t.length;j++){o[j]=(o[j-1]*(p-1)+t[j])/p}return o}
function utBot(c,kv=2,aP=10){const n=c.length;const out={trend:new Array(n).fill(0),upper:new Array(n).fill(NaN),lower:new Array(n).fill(NaN)};const A=atr(c,aP);for(let i=0;i<n;i++){const x=c[i];const hl2=(x.high+x.low)/2;const nLoss=kv*A[i];if(!isFinite(nLoss)){out.trend[i]=i?out.trend[i-1]:0;continue}const bU=hl2+nLoss,bL=hl2-nLoss; if(i===0){out.upper[i]=bU; out.lower[i]=bL;} else {const pU=out.upper[i-1], pL=out.lower[i-1]; out.upper[i]=(bU<pU||x.close>pU)?bU:pU; out.lower[i]=(bL>pL||x.close<pL)?bL:pL;} const up=out.upper[i], dn=out.lower[i]; const prev=i?out.trend[i-1]:0; out.trend[i]= x.close>up?1 : x.close<dn?-1 : prev;} return out}
function linRegChannel(c,l=100,u=2,d=2){const n=c.length;const mid=new Array(n).fill(NaN),up=new Array(n).fill(NaN),dn=new Array(n).fill(NaN);for(let i=l-1;i<n;i++){const sl=c.slice(i-l+1,i+1);const y=sl.map(z=>z.close);const M=y.length;const X=[...Array(M).keys()];const SX=X.reduce((a,b)=>a+b,0), SY=y.reduce((a,b)=>a+b,0), SXX=X.reduce((a,b)=>a+b*b,0), SXY=X.reduce((a,b,j)=>a+b*y[j],0);const D=M*SXX-SX*SX;const slope=D!==0?(M*SXY-SX*SY)/D:0;const intercept=(SY-slope*SX)/M;const yHat=intercept+slope*(M-1);const s2=y.reduce((a,v,j)=>{const est=intercept+slope*j;return a+(v-est)*(v-est)},0)/M;const sd=Math.sqrt(s2);mid[i]=yHat;up[i]=yHat+u*sd;dn[i]=yHat-d*sd}return{mid,up,dn}}

/* ===== Core Step ===== */
async function step(){
  try{
    const symbol = $("symbol").value.trim().toUpperCase();
    const interval = $("interval").value;
    const limit = +$("limit").value || 500;

    const [candles, lastPx] = await Promise.all([
      getKlines(symbol, interval, limit),
      getLastPrice(symbol)
    ]);
    if(lastPx) $("live").textContent = lastPx.toFixed(6);
    if(!candles.length) return;

    const ut = utBot(candles, +$("kv").value, +$("atr").value);
    const lr = linRegChannel(candles, +$("lrLen").value, +$("devUp").value, +$("devDn").value);

    const last = candles.at(-1);
    const prevTrend = ut.trend.at(-2) ?? 0;
    const nowTrend  = ut.trend.at(-1) ?? 0;

    $("sig").textContent = nowTrend>0?"BUY":nowTrend<0?"SELL":"-";
    $("sig").className = "badge " + (nowTrend>0?"ok":nowTrend<0?"bad":"");
    $("lastUpdate").textContent = `TF ${interval} • ${new Date(last.time*1000).toLocaleString()}`;

    // Kirim alert hanya saat cross (prev -1 -> 1 atau 1 -> -1) dan sekali per bar
    const barKey = last.time;
    if (state.lastAlertBar !== barKey && prevTrend !== nowTrend && nowTrend !== 0){
      const side = nowTrend>0 ? "BUY" : "SELL";
      log(`${side} ${symbol} @ ~${(lastPx||last.close).toFixed(6)}`);
      sendEmailAlert(side, symbol, lastPx||last.close, new Date(last.time*1000).toLocaleString());
      state.lastAlertBar = barKey;
    }
    state.lastTrend = nowTrend;
  }catch(e){
    log("Error: "+(e.message||e));
  }
}

/* ===== Email Sender ===== */
async function sendEmailAlert(side, symbol, price, timeStr){
  try{
    if(!(state.email.service && state.email.template && state.email.user)) return;
    await emailjs.send(state.email.service, state.email.template, {
      signal: side, symbol, price: String(price), time: timeStr, to: state.email.to
    });
    log("Email terkirim");
  }catch(e){ log("Email gagal: "+(e.text||e.message||e)); }
}

/* ===== Controls ===== */
$("btnToggle").onclick = ()=>{
  state.running = !state.running;
  $("btnToggle").textContent = state.running ? "Stop" : "Start";
  setStatus(state.running ? "Running" : "Idle");
  if(state.running){
    step();
    if(!state.timer) state.timer = setInterval(step, 30000); // 30s
  } else {
    if(state.timer){ clearInterval(state.timer); state.timer=null; }
  }
};

/* ===== Init ===== */
setStatus("Idle");
log("Siap. Isi EmailJS (service/template/public key), lalu tekan Start untuk kirim alert BUY/SELL.");
</script>
</body>
</html>
