<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>XRP/USDT Auto Signal Bot</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #0b0f14; color: #eee; }
    #chart { height: 500px; }
    button, select { padding: 8px 12px; margin: 6px; border-radius: 8px; }
    #log { background: #111; color: #0f0; padding: 10px; height: 180px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>XRP/USDT Auto Signal Bot (UTBot + LRC)</h2>
  <label>Interval:
    <select id="interval">
      <option value="1m">1m</option>
      <option value="5m">5m</option>
      <option value="15m">15m</option>
      <option value="1h">1h</option>
    </select>
  </label>
  <button id="start">Start Bot</button>
  <div id="chart"></div>
  <pre id="log"></pre>

<script>
emailjs.init("YOUR_PUBLIC_KEY"); // ganti dengan EmailJS public key

const log = (msg) => {
  const ts = new Date().toLocaleTimeString();
  document.getElementById("log").textContent += `[${ts}] ${msg}\n`;
};

const chart = LightweightCharts.createChart(document.getElementById("chart"), {
  layout: { background: { color: "#0b0f14" }, textColor: "#eee" },
  grid: { vertLines: { color: "#222" }, horzLines: { color: "#222" } },
  timeScale: { timeVisible: true, secondsVisible: false }
});
const candleSeries = chart.addCandlestickSeries();
const buySeries = chart.addLineSeries({ color: "lime", lineWidth: 2 });
const sellSeries = chart.addLineSeries({ color: "red", lineWidth: 2 });
const lrUpSeries = chart.addLineSeries({ color: "orange", lineWidth: 1 });
const lrDnSeries = chart.addLineSeries({ color: "orange", lineWidth: 1 });
const lrMidSeries = chart.addLineSeries({ color: "yellow", lineWidth: 1 });

let candles = [];
let signals = [];
let currentInterval = "1m";

// ====== Fetch Candle Data from Binance ======
async function fetchCandles() {
  const url = `https://api.binance.com/api/v3/klines?symbol=XRPUSDT&interval=${currentInterval}&limit=500`;
  const res = await fetch(url);
  const data = await res.json();
  candles = data.map(c => ({
    time: Math.floor(c[0]/1000),
    open: parseFloat(c[1]),
    high: parseFloat(c[2]),
    low: parseFloat(c[3]),
    close: parseFloat(c[4])
  }));
  candleSeries.setData(candles);
}

// ====== ATR Calculation ======
function calcATR(period=14) {
  let atr = [];
  for (let i=1;i<candles.length;i++) {
    const prev = candles[i-1];
    const cur = candles[i];
    const tr = Math.max(cur.high-cur.low, Math.abs(cur.high-prev.close), Math.abs(cur.low-prev.close));
    if (i < period) { atr.push(null); continue; }
    const prevATR = atr[i-1] || tr;
    atr.push((prevATR*(period-1)+tr)/period);
  }
  return atr;
}

// ====== UT Bot Alerts ======
function UTBotAlerts(atrLen=2, factor=10) {
  const atr = calcATR(atrLen);
  let trend = null;
  signals = [];
  for (let i=0;i<candles.length;i++) {
    const c = candles[i];
    if (!atr[i]) continue;
    const upper = c.close - factor*atr[i];
    const lower = c.close + factor*atr[i];
    if (trend !== "BUY" && c.close > lower) {
      trend = "BUY"; signals.push({ time:c.time, price:c.close, side:"BUY" });
    } else if (trend !== "SELL" && c.close < upper) {
      trend = "SELL"; signals.push({ time:c.time, price:c.close, side:"SELL" });
    }
  }
  return signals;
}

// ====== Linear Regression Channel ======
function linearRegressionChannel(length=100, dev=2) {
  if (candles.length < length) return null;
  const closes = candles.slice(-length).map(c=>c.close);
  const times = [...Array(length).keys()];
  const n = length;
  const sumX = times.reduce((a,b)=>a+b,0);
  const sumY = closes.reduce((a,b)=>a+b,0);
  const sumXY = times.reduce((a,b,i)=>a+b*closes[i],0);
  const sumX2 = times.reduce((a,b)=>a+b*b,0);
  const slope = (n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
  const intercept = (sumY - slope*sumX)/n;
  let mid=[], up=[], dn=[];
  const mean = sumY/n;
  const std = Math.sqrt(closes.reduce((a,b)=>a+(b-mean)**2,0)/n);
  for (let i=0;i<length;i++) {
    const price = intercept + slope*i;
    mid.push({ time:candles[candles.length-length+i].time, value:price });
    up.push({ time:candles[candles.length-length+i].time, value:price+dev*std });
    dn.push({ time:candles[candles.length-length+i].time, value:price-dev*std });
  }
  lrMidSeries.setData(mid);
  lrUpSeries.setData(up);
  lrDnSeries.setData(dn);
  return { mid, up, dn };
}

// ====== Send Email via EmailJS ======
function sendEmail(signal, lr) {
  const params = {
    side: signal.side,
    price: signal.price.toFixed(4),
    time: new Date(signal.time*1000).toLocaleString(),
    pair: "XRP/USDT",
    interval: currentInterval,
    dev_up: lr.up.at(-1).value.toFixed(4),
    dev_dn: lr.dn.at(-1).value.toFixed(4),
    to: "youremail@example.com" // ganti email tujuan
  };
  emailjs.send("YOUR_SERVICE_ID","YOUR_TEMPLATE_ID",params)
    .then(()=> log(`ðŸ“§ Email sent for ${signal.side} at ${signal.price}`))
    .catch(err=> log("Email error: "+err));
}

// ====== Main Run ======
document.getElementById("start").onclick = async () => {
  currentInterval = document.getElementById("interval").value;
  await fetchCandles();
  setInterval(async ()=>{
    await fetchCandles();
    const signals = UTBotAlerts(2,10);
    const lr = linearRegressionChannel(100,2);
    if (signals.length>0) {
      const last = signals.at(-1);
      log(`${last.side} @ ${last.price}`);
      if (last.side==="BUY") buySeries.update({ time:last.time, value:last.price });
      if (last.side==="SELL") sellSeries.update({ time:last.time, value:last.price });
      sendEmail(last, lr);
    }
  }, 60*1000); // tiap 1 menit
};
</script>
</body>
</html>
