<!DOCTYPE html>
<html>
<head>
  <title>CAKE/IDR Trading Signal (UT Bot + LRC)</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; text-align: center; }
    #chart { width: 100%; height: 400px; margin-top: 10px; }
    #status { margin: 10px 0; font-size: 16px; }
    #signal { font-size: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>CAKE/IDR Trading Signal</h2>
  <div id="status">Loading...</div>
  <div id="signal">Waiting signal...</div>
  <div id="chart"></div>

  <script>
    emailjs.init("aPZx0R9oxUbIQkLEv"); // Ganti dengan User ID EmailJS kamu

    let prices = [], highs = [], lows = [];
    let lastSignal = "HOLD ‚è≥";
    let chart, candleSeries;

    function setupChart() {
      chart = LightweightCharts.createChart(document.getElementById("chart"), {
        layout: { background: { color: "#111" }, textColor: "#eee" },
        grid: { vertLines: { color: "#333" }, horzLines: { color: "#333" } },
      });
      candleSeries = chart.addCandlestickSeries();
    }

    function calcATR(period = 10) {
      if (prices.length < period + 1) return null;
      let trs = [];
      for (let i = prices.length - period; i < prices.length; i++) {
        let high = highs[i], low = lows[i], closePrev = prices[i - 1];
        let tr = Math.max(high - low, Math.abs(high - closePrev), Math.abs(low - closePrev));
        trs.push(tr);
      }
      return trs.reduce((a, b) => a + b, 0) / trs.length;
    }

    function calcLinearRegression(len = 100) {
      if (prices.length < len) return null;
      let y = prices.slice(-len);
      let x = [...Array(len).keys()];
      let n = len;
      let sumX = x.reduce((a, b) => a + b, 0);
      let sumY = y.reduce((a, b) => a + b, 0);
      let sumXY = x.map((xi, i) => xi * y[i]).reduce((a, b) => a + b, 0);
      let sumXX = x.map(xi => xi * xi).reduce((a, b) => a + b, 0);
      let slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
      let intercept = (sumY - slope * sumX) / n;
      let reg = x.map(xi => intercept + slope * xi);
      let mean = reg.reduce((a, b) => a + b, 0) / reg.length;
      let variance = reg.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / reg.length;
      let stdev = Math.sqrt(variance);
      return { mid: reg[reg.length - 1], upper: reg[reg.length - 1] + 2 * stdev, lower: reg[reg.length - 1] - 2 * stdev };
    }

    function sendEmail(signal, price) {
      emailjs.send("service_d48312b", "template_1ktk40q", {
        signal: signal,
        price: price,
        pair: "CAKE/IDR",
        time: new Date().toLocaleString()
      }).then(() => console.log("Email terkirim"), (err) => console.error("Email error", err));
    }

    async function getPrice() {
      try {
        let res = await fetch(`https://api.coingecko.com/api/v3/coins/pancakeswap-token/ohlc?vs_currency=idr&days=1`);
        let data = await res.json();
        if (!Array.isArray(data) || data.length === 0) throw new Error("Invalid OHLC response");

        let lastCandle = data[data.length - 1];
        let [time, open, high, low, close] = lastCandle;

        prices.push(close); highs.push(high); lows.push(low);
        if (prices.length > 500) { prices.shift(); highs.shift(); lows.shift(); }

        document.getElementById("status").innerText = `Last: ${close} (CAKE/IDR)`;

        let atr = calcATR(10);
        let lrc = calcLinearRegression(100);
        if (!atr || !lrc) return;

        let baseline = prices[prices.length - 2] + 2 * atr * (close > prices[prices.length - 2] ? 1 : -1);

        let signal = "HOLD ‚è≥";
        if (close > baseline && close > lrc.upper) {
          signal = "SELL üö®";
        } else if (close < baseline && close < lrc.lower) {
          signal = "BUY ‚úÖ";
        }

        document.getElementById("signal").innerText = "Signal: " + signal;

        if (signal !== lastSignal && signal !== "HOLD ‚è≥") {
          lastSignal = signal;
          sendEmail(signal, close);
        }

        candleSeries.update({ time: Math.floor(time / 1000), open, high, low, close });

      } catch (err) {
        document.getElementById("status").innerText = "Error: " + err;
      }
    }

    setupChart();
    setInterval(getPrice, 10000); // ambil data tiap 10 detik
  </script>
</body>
</html>
