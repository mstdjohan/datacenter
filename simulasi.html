<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Strategi Otomatis CAKE/USDT</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; color: #333; }
    .container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; }
    .log { background: #eee; padding: 10px; margin-top: 20px; white-space: pre-line; height: 200px; overflow-y: auto; font-family: monospace; border-radius: 5px; }
    canvas { margin-top: 20px; max-width: 100%; }
    .summary { margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; }
    .summary input { width: 100px; padding: 5px; margin-right: 10px; }
    .summary label { font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÅ Strategi Otomatis CAKE/USDT</h1>
    <div id="livePrice">Harga: Memuat...</div>

    <div class="summary">
      <label>üí∞ Modal Awal ($):</label>
      <input type="number" id="initialCapitalInput" value="1000" />
      <label>üìà Modal Saat Ini: </label>
      <span id="currentCapitalDisplay">$1000.00</span>
    </div>

    <canvas id="chartCanvas" width="600" height="250"></canvas>
    <div class="log" id="logBox">üìù Log strategi...</div>
  </div>

  <script>
    emailjs.init("OGH12a8LlCboHPVz8");

    // Ambil dari localStorage (jika ada)
    let lastBuy = parseFloat(localStorage.getItem("lastBuy")) || null;
    let highestSinceBuy = parseFloat(localStorage.getItem("highestSinceBuy")) || null;
    let currentPositionAmount = parseFloat(localStorage.getItem("currentPositionAmount")) || 0;
    let capital = parseFloat(localStorage.getItem("capital")) || 1000;
    let currentCapital = capital;

    const qtyPerTrade = 100;
    const priceData = [], timeLabels = [];
    const logBox = document.getElementById("logBox");
    const ctx = document.getElementById("chartCanvas").getContext("2d");

    // Inisialisasi modal awal dari input
    document.getElementById("initialCapitalInput").value = capital;
    function updateCapitalDisplay() {
      document.getElementById("currentCapitalDisplay").textContent = `$${currentCapital.toFixed(2)}`;
      localStorage.setItem("capital", currentCapital);
    }

    document.getElementById("initialCapitalInput").addEventListener("change", () => {
      capital = parseFloat(document.getElementById("initialCapitalInput").value);
      currentCapital = capital;
      localStorage.setItem("capital", capital);
      updateCapitalDisplay();
    });

    updateCapitalDisplay();

    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: timeLabels,
        datasets: [{
          label: "Harga CAKE/USDT",
          data: priceData,
          borderColor: "blue",
          backgroundColor: "rgba(0,0,255,0.1)",
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: "Waktu" }},
          y: { title: { display: true, text: "USD" }}
        }
      }
    });

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      const text = `[${now}] ${msg}\n`;
      logBox.textContent += text;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function sendEmail(subject, message) {
      emailjs.send("service_5hxo1hk", "template_iq87egh", {
        subject: subject,
        message: message,
      }).then(() => {
        log("üì© Notifikasi email dikirim.");
      }).catch((err) => {
        log("‚ùå Gagal kirim email: " + err.text);
      });
    }

    async function fetchAndEvaluate() {
      try {
        const res = await fetch("https://api.dexscreener.com/latest/dex/pairs/bsc/0x0ed7e52944161450477ee417de9cd3a859b14fd0");
        const data = await res.json();
        const price = parseFloat(data.pair.priceUsd);
        document.getElementById("livePrice").textContent = `Harga: $${price.toFixed(4)}`;

        const now = new Date().toLocaleTimeString();
        priceData.push(price);
        timeLabels.push(now);
        if (priceData.length > 20) {
          priceData.shift();
          timeLabels.shift();
        }
        chart.update();

        if (!lastBuy) {
          // BUY pertama
          lastBuy = price;
          highestSinceBuy = price;
          currentPositionAmount = qtyPerTrade / price;
          currentCapital -= qtyPerTrade;

          // Simpan ke storage
          localStorage.setItem("lastBuy", lastBuy);
          localStorage.setItem("highestSinceBuy", highestSinceBuy);
          localStorage.setItem("currentPositionAmount", currentPositionAmount);
          localStorage.setItem("capital", currentCapital);

          updateCapitalDisplay();
          log(`üì• BUY di $${price.toFixed(4)} (${currentPositionAmount.toFixed(4)} CAKE)`);
          sendEmail("BUY Signal", `Beli CAKE di harga $${price.toFixed(4)}`);
        } else {
          if (price > highestSinceBuy) highestSinceBuy = price;
          localStorage.setItem("highestSinceBuy", highestSinceBuy);

          const dropFromPeak = ((highestSinceBuy - price) / highestSinceBuy) * 100;
          const lossFromBuy = ((lastBuy - price) / lastBuy) * 100;

          if (dropFromPeak > 1.0) {
            const sellValue = price * currentPositionAmount;
            currentCapital += sellValue;
            updateCapitalDisplay();
            log(`üì§ SELL (Trailing) di $${price.toFixed(4)} | Balik: $${sellValue.toFixed(2)} | Modal: $${currentCapital.toFixed(2)}`);
            sendEmail("SELL (Trailing Profit)", `Jual CAKE di $${price.toFixed(4)}. Saldo: $${currentCapital.toFixed(2)}`);

            // Reset posisi
            lastBuy = null;
            highestSinceBuy = null;
            currentPositionAmount = 0;
            localStorage.removeItem("lastBuy");
            localStorage.removeItem("highestSinceBuy");
            localStorage.removeItem("currentPositionAmount");
          } else if (lossFromBuy > 1.5) {
            const sellValue = price * currentPositionAmount;
            currentCapital += sellValue;
            updateCapitalDisplay();
            log(`üì§ SELL (Cut Loss) di $${price.toFixed(4)} | Balik: $${sellValue.toFixed(2)} | Modal: $${currentCapital.toFixed(2)}`);
            sendEmail("SELL (Cut Loss)", `Jual CAKE rugi di $${price.toFixed(4)}. Saldo: $${currentCapital.toFixed(2)}`);

            // Reset posisi
            lastBuy = null;
            highestSinceBuy = null;
            currentPositionAmount = 0;
            localStorage.removeItem("lastBuy");
            localStorage.removeItem("highestSinceBuy");
            localStorage.removeItem("currentPositionAmount");
          } else {
            log(`‚è≥ HOLD | Harga: $${price.toFixed(4)} | Peak: $${highestSinceBuy.toFixed(4)}`);
          }
        }

      } catch (err) {
        log("‚ùå Gagal ambil harga");
        console.error(err);
      }
    }

    // Start
    fetchAndEvaluate();
    setInterval(fetchAndEvaluate, 30000);
  </script>
</body>
</html>
