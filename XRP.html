
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Email Notify — AutoBot</title>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;background:#f7fafc;color:#111}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.04);max-width:900px;margin:12px auto}
    .row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    input,select,button,textarea{padding:8px 10px;border-radius:8px;border:1px solid #e6e6e6;font-size:14px}
    button{cursor:pointer}
    .log{height:220px;overflow:auto;background:#0f172a;color:#fff;padding:8px;border-radius:8px;font-family:monospace}
    label{font-size:13px;color:#374151}
    .small{font-size:12px;color:#6b7280}
    .flex{display:flex;gap:8px}
  </style>

  <!-- EmailJS browser SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
  <div class="card">
    <h2>EmailJS Notifier — AutoBot</h2>
    <p class="small">Form ini memungkinkan browser mengirim email notifikasi (BUY / SELL). Gunakan EmailJS — <strong>tidak perlu backend</strong> (tetapi kunci publik akan berada di browser).</p>

    <div style="margin-top:12px">
      <label>Public user ID (EmailJS user_id)</label><br>
      <input id="userId" placeholder="YOUR_USER_ID (emailjs user_id)" style="width:100%" />
    </div>

    <div style="margin-top:8px" class="row">
      <div style="flex:1">
        <label>Service ID</label><br>
        <input id="serviceId" placeholder="YOUR_SERVICE_ID (e.g. default_service)" style="width:100%" />
      </div>
      <div style="flex:1">
        <label>Template ID</label><br>
        <input id="templateId" placeholder="YOUR_TEMPLATE_ID" style="width:100%" />
      </div>
    </div>

    <div style="margin-top:8px" class="row">
      <div style="flex:1">
        <label>To (override; optional)</label><br>
        <input id="toEmail" placeholder="optional: target receiver email" style="width:100%" />
        <div class="small">Kosongkan jika template EmailJS tidak butuh email penerima.</div>
      </div>
      <div style="flex:1">
        <label>Pair / Tag</label><br>
        <input id="pair" value="CAKEUSDT" style="width:100%" />
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <button id="btnInit">Init EmailJS</button>
      <button id="btnSave">Save config (localStorage)</button>
      <button id="btnClear">Clear saved</button>
    </div>

    <hr/>

    <div class="row">
      <button id="btnSimBuy" style="background:#2563eb;color:white">Manual BUY (simulate)</button>
      <button id="btnSimSell" style="background:#f59e0b;color:white">Manual SELL (simulate)</button>
      <button id="btnAutoOn" style="background:#10b981;color:white">Toggle Auto Sim (every 10s)</button>
      <span class="small">Auto sim memicu sinyal BUY/SELL acak setiap 10s (demo)</span>
    </div>

    <div style="margin-top:12px">
      <label>Custom message (optional)</label><br>
      <textarea id="customMsg" rows="3" style="width:100%"></textarea>
    </div>

    <h3 style="margin-top:12px">Log</h3>
    <div class="log" id="log"></div>

    <div class="small" style="margin-top:8px">
      <strong>Petunjuk singkat EmailJS:</strong>
      <ol>
        <li>Daftar di <a href="https://www.emailjs.com" target="_blank">emailjs.com</a> dan dapatkan <code>user_id</code>.</li>
        <li>Buat Service (mis. Gmail, SMTP) → <code>service_id</code>.</li>
        <li>Buat Template (HTML/text) → <code>template_id</code>. Pastikan template menerima fields seperti <code>subject</code>, <code>title</code>, <code>message</code>, <code>pair</code>, <code>time</code>, <code>to_email</code> (opsional).</li>
        <li>Masukkan three IDs di atas, klik <em>Init EmailJS</em>.</li>
      </ol>
    </div>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const logEl = $('log');

  function log(msg){
    const t = new Date().toLocaleTimeString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    console.log(msg);
  }

  // store/load config in localStorage
  function saveCfg(){
    localStorage.setItem('emailjs_cfg', JSON.stringify({
      userId: $('userId').value.trim(),
      serviceId: $('serviceId').value.trim(),
      templateId: $('templateId').value.trim(),
      toEmail: $('toEmail').value.trim(),
      pair: $('pair').value.trim()
    }));
    log('Config saved to localStorage');
  }
  function loadCfg(){
    const raw = localStorage.getItem('emailjs_cfg');
    if (!raw) return;
    try {
      const cfg = JSON.parse(raw);
      $('userId').value = cfg.userId || '';
      $('serviceId').value = cfg.serviceId || '';
      $('templateId').value = cfg.templateId || '';
      $('toEmail').value = cfg.toEmail || '';
      $('pair').value = cfg.pair || 'CAKEUSDT';
      log('Config loaded from localStorage');
    } catch(e){ log('Load config error: '+e.message); }
  }
  function clearCfg(){
    localStorage.removeItem('emailjs_cfg');
    log('Saved config cleared');
  }

  // EmailJS init & send
  let emailjsReady = false;
  function initEmailJS(){
    const userId = $('userId').value.trim();
    if (!userId) { log('Init failed: userId empty'); return; }
    try {
      emailjs.init(userId);
      emailjsReady = true;
      log('EmailJS initialized with userId: ' + userId);
    } catch (e){
      log('EmailJS init error: ' + (e.message || e));
    }
  }

  /**
   * sendEmailJS(subject, title, message, overrides)
   * overrides: { to_email(optional), pair(optional), extraParams(optional object) }
   */
  async function sendEmailJS(subject, title, message, overrides = {}) {
    try {
      if (!emailjsReady) {
        log('EmailJS not initialized — calling initEmailJS() automatically if userId provided');
        initEmailJS();
        if (!emailjsReady) throw new Error('EmailJS not initialized');
      }
      const serviceId = $('serviceId').value.trim();
      const templateId = $('templateId').value.trim();
      if (!serviceId || !templateId) throw new Error('serviceId/templateId missing');

      const toEmail = overrides.to_email || $('toEmail').value.trim() || '';
      const pair = overrides.pair || $('pair').value.trim() || '';

      // template parameters: adjust to what your EmailJS template expects
      const templateParams = {
        subject: subject,
        title: title,
        message: message,
        pair: pair,
        time: new Date().toLocaleString(),
        to_email: toEmail
      };

      // merge extras
      if (overrides.extraParams && typeof overrides.extraParams === 'object') {
        Object.assign(templateParams, overrides.extraParams);
      }

      log(`Sending email -> service:${serviceId} template:${templateId} subject:${subject}`);
      const resp = await emailjs.send(serviceId, templateId, templateParams);
      log('Email sent (OK). Response status: ' + (resp.status || 'unknown'));
      return resp;
    } catch (err) {
      log('Email send failed: ' + (err.text || err.message || err));
      throw err;
    }
  }

  // Expose a global function onSignal so you can call it from your trading script:
  // window.onSignal('buy'|'sell', { price, estAmount, txHash })
  window.onSignal = async function(signal, meta = {}) {
    try {
      const price = meta.price ?? '—';
      const est = meta.est ?? '-';
      const tx = meta.tx ?? '-';
      const subject = signal === 'buy' ? 'SIGNAL BUY' : 'SIGNAL SELL';
      const title = `${signal.toUpperCase()} ${$('pair').value || ''} @ ${price}`;
      const message = `Signal: ${signal.toUpperCase()}\nPair: ${$('pair').value || ''}\nPrice: ${price}\nEstimate: ${est}\nTX: ${tx}\nExtra: ${$('customMsg').value || ''}`;
      log(`Signal received: ${signal.toUpperCase()} — sending email...`);
      await sendEmailJS(subject, title, message, { to_email: $('toEmail').value.trim() || undefined, pair: $('pair').value.trim() });
      log('Notification email sent for ' + signal.toUpperCase());
    } catch (e){
      log('onSignal error: ' + (e.message || e));
    }
  };

  // demo auto-sim (trigger random buy/sell every 10s when enabled)
  let autoTimer = null;
  function toggleAutoSim(){
    if (autoTimer) {
      clearInterval(autoTimer);
      autoTimer = null;
      $('btnAutoOn').textContent = 'Toggle Auto Sim (every 10s)';
      log('Auto sim stopped');
      return;
    }
    autoTimer = setInterval(()=> {
      // random pick buy or sell
      const s = Math.random() > 0.5 ? 'buy' : 'sell';
      const p = (Math.random() * 0.6 + 2.0).toFixed(3); // random price demo
      window.onSignal(s, { price: p, est: 'demo', tx: '-' });
    }, 10000);
    $('btnAutoOn').textContent = 'Stop Auto Sim';
    log('Auto sim started (every 10s)');
  }

  // wiring UI
  $('btnInit').addEventListener('click', initEmailJS);
  $('btnSave').addEventListener('click', saveCfg);
  $('btnClear').addEventListener('click', ()=>{ clearCfg(); loadCfg(); });
  $('btnSimBuy').addEventListener('click', ()=> window.onSignal('buy', { price: (Math.random()*0.6+2.0).toFixed(3), est: 'demo' }));
  $('btnSimSell').addEventListener('click', ()=> window.onSignal('sell', { price: (Math.random()*0.6+2.0).toFixed(3), est: 'demo' }));
  $('btnAutoOn').addEventListener('click', toggleAutoSim);

  // load saved config if any
  loadCfg();

  // expose sendEmailJS for manual tests
  window.sendEmailJS = sendEmailJS;

  log('EmailJS notifier ready. Fill IDs & click Init.');
})();
</script>
</body>
</html>
