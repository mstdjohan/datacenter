<!DOCTYPE html>
<html>
<head>
  <title>XRP/USDT Signal Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/technicalindicators@3.0.0/dist/browser.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #000; color: #fff; text-align: center; }
    #chart-container { width: 90vw; height: 60vh; margin: auto; }
    .signal { font-size: 20px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>XRP/USDT - Sinyal RSI + MACD</h2>
  <div id="chart-container"><canvas id="priceChart"></canvas></div>
  <div class="signal" id="signalResult">‚è≥ Menunggu sinyal...</div>

  <script>
    emailjs.init("aPZx0R9oxUbIQkLEv"); // Ganti dengan public key kamu

    const API_URL = "https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd";
    const labels = [], priceData = [], buySignals = [], sellSignals = [];
    const chart = new Chart(document.getElementById('priceChart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'XRP/USDT', data: priceData, borderColor: '#0f0', borderWidth: 2, pointRadius: 1 },
          { label: 'BUY Signals', data: buySignals, pointBackgroundColor: 'lime', pointRadius: 6, showLine: false, type: 'scatter' },
          { label: 'SELL Signals', data: sellSignals, pointBackgroundColor: 'red', pointRadius: 6, showLine: false, type: 'scatter' }
        ]
      },
      options: {
        scales: { x: { ticks: { color: '#aaa' } }, y: { ticks: { color: '#aaa' } } },
        plugins: { legend: { labels: { color: '#aaa' } } }
      }
    });

    let lastSignalType = localStorage.getItem("lastSignalType") || null;

    async function fetchPrice() {
      try {
        const res = await fetch(API_URL);
        const json = await res.json();
        const price = parseFloat(json.ripple.usd);
        const now = new Date().toLocaleTimeString();

        labels.push(now);
        priceData.push(price);
        if (labels.length > 100) {
          labels.shift(); priceData.shift(); buySignals.shift(); sellSignals.shift();
        }

        checkSignals(now, price);
        chart.update();
      } catch (e) {
        document.getElementById('signalResult').textContent = "‚ö†Ô∏è Gagal ambil data!";
      }
    }

    function checkSignals(time, price) {
      if (priceData.length < 26) return;
      const rsi = technicalindicators.RSI.calculate({ values: priceData, period: 14 });
      const macd = technicalindicators.MACD.calculate({
        values: priceData, fastPeriod: 12, slowPeriod: 26, signalPeriod: 9,
        SimpleMAOscillator: false, SimpleMASignal: false
      });

      const lastRSI = rsi[rsi.length - 1];
      const lastMACD = macd[macd.length - 1];
      let signalText = "‚è≥ Menunggu sinyal...";
      let newSignalType = null;

      if (lastRSI < 30 && lastMACD.histogram > 0) {
        signalText = `üü¢ BUY signal @${price}`;
        newSignalType = "BUY";
      } else if (lastRSI > 70 && lastMACD.histogram < 0) {
        signalText = `üî¥ SELL signal @${price}`;
        newSignalType = "SELL";
      }

      document.getElementById('signalResult').textContent = signalText;

      if (newSignalType && newSignalType !== lastSignalType) {
        if (newSignalType === "BUY") {
          buySignals.push({ x: time, y: price }); sellSignals.push(null);
        } else {
          sellSignals.push({ x: time, y: price }); buySignals.push(null);
        }

        lastSignalType = newSignalType;
        localStorage.setItem("lastSignalType", newSignalType);

        sendEmail(signalText);
        sendLogToServer(newSignalType, price, time);
      } else {
        buySignals.push(null); sellSignals.push(null);
      }
    }

    function sendEmail(message) {
      emailjs.send("service_d48312b", "template_1ktk40q", {
        message: message,
        time: new Date().toLocaleString()
      }).then(() => {
        console.log("‚úÖ Email terkirim:", message);
      }).catch(error => {
        console.error("‚ùå Gagal kirim email:", error);
      });
    }

    function sendLogToServer(type, price, time) {
      fetch("save_log.php", {
        method: "POST",
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `type=${type}&price=${price}&time=${time}`
      }).then(res => res.text()).then(console.log).catch(console.error);
    }

    setInterval(fetchPrice, 30000); // 30 detik
  </script>
</body>
</html>
