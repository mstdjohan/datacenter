<!DOCTYPE html>
<html>
<head>
  <title>XRP/USDT Signal Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/technicalindicators@3.0.0/dist/browser.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #000; color: #fff; text-align: center; }
    #chart-container { width: 90vw; height: 60vh; margin: auto; }
    .signal { font-size: 20px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>XRP/USDT - Sinyal RSI + MACD (Persisten + Email)</h2>
  <div id="chart-container">
    <canvas id="priceChart"></canvas>
  </div>
  <div class="signal" id="signalResult">‚è≥ Menunggu sinyal...</div>

  <script>
    emailjs.init("aPZx0R9oxUbIQkLEv");

    const API_URL = "https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd";
    const MAX_LENGTH = 50;
    const priceData = JSON.parse(localStorage.getItem("priceData")) || [];
    const labels = JSON.parse(localStorage.getItem("labels")) || [];
    let lastSignalType = localStorage.getItem("lastSignalType") || "";

    const chart = new Chart(document.getElementById('priceChart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'XRP/USDT',
          data: priceData,
          borderColor: '#0f0',
          borderWidth: 2,
          pointRadius: 1,
        }]
      },
      options: {
        scales: {
          x: { ticks: { color: '#aaa' } },
          y: { ticks: { color: '#aaa' } }
        }
      }
    });

    async function fetchPrice() {
      try {
        const res = await fetch(API_URL);
        const json = await res.json();
        const price = parseFloat(json.ripple.usd);

        const now = new Date().toLocaleTimeString();
        labels.push(now);
        priceData.push(price);
        if (labels.length > MAX_LENGTH) {
          labels.shift();
          priceData.shift();
        }

        localStorage.setItem("priceData", JSON.stringify(priceData));
        localStorage.setItem("labels", JSON.stringify(labels));
        chart.update();

        checkSignals();
      } catch (e) {
        console.error("Gagal ambil data:", e);
        document.getElementById('signalResult').textContent = "‚ö†Ô∏è Gagal ambil data!";
      }
    }

    function sendEmail(signalText) {
      emailjs.send("service_d48312b", "template_1ktk40q", {
        name: "XRP/USDT Bot",
        message: signalText,
      }).then(() => {
        console.log("‚úÖ Email terkirim:", signalText);
      }).catch(err => {
        console.error("‚ùå Gagal kirim email:", err);
      });
    }

    function checkSignals() {
      if (priceData.length < 26) return;

      const rsi = technicalindicators.RSI.calculate({
        values: priceData,
        period: 14
      });

      const macd = technicalindicators.MACD.calculate({
        values: priceData,
        fastPeriod: 12,
        slowPeriod: 26,
        signalPeriod: 9,
        SimpleMAOscillator: false,
        SimpleMASignal: false
      });

      const lastRSI = rsi[rsi.length - 1];
      const lastMACD = macd[macd.length - 1];
      let signalText = "‚è≥ Menunggu sinyal...";
      let newSignalType = "";

      if (lastRSI < 30 && lastMACD.histogram > 0) {
        signalText = "üü¢ BUY signal - RSI rendah & MACD positif";
        newSignalType = "BUY";
      } else if (lastRSI > 70 && lastMACD.histogram < 0) {
        signalText = "üî¥ SELL signal - RSI tinggi & MACD negatif";
        newSignalType = "SELL";
      }

      document.getElementById('signalResult').textContent = signalText;

      if (newSignalType && newSignalType !== lastSignalType) {
        sendEmail(signalText);
        lastSignalType = newSignalType;
        localStorage.setItem("lastSignalType", lastSignalType);
      }
    }

    setInterval(fetchPrice, 30000);
    fetchPrice(); // jalankan langsung
  </script>
</body>
</html>
