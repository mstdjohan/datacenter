<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Strategi Trading CAKE - Delay Buy 15 Menit</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    emailjs.init("OGH12a8LlCboHPVz8"); /* Ganti dengan public key emailjs kamu */
  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    canvas { background: white; border: 1px solid #ccc; }
    #log { margin-top: 20px; white-space: pre-wrap; font-family: monospace; }
  </style>
</head>
<body>

<h2>üìä Harga CAKE & Indikator (Real-time)</h2>
<div>üí∞ Harga Live: <span id="livePrice">Memuat...</span></div>
<canvas id="chart" width="800" height="400"></canvas>
<div>üíº Modal: <span id="capital">$1000.00</span></div>
<div id="log"></div>

<script>
let priceData = [];
let timeLabels = [];
let currentCapital = parseFloat(localStorage.getItem("capital_cake")) || 1000;
let qtyPerTrade = 100;
let lastBuy = parseFloat(localStorage.getItem("lastBuy_cake")) || null;
let highestSinceBuy = parseFloat(localStorage.getItem("highestSinceBuy_cake")) || null;
let currentPositionAmount = parseFloat(localStorage.getItem("currentPositionAmount_cake")) || 0;
let buySignalStart = parseFloat(localStorage.getItem("buySignalStart_cake")) || null;

const chartCtx = document.getElementById('chart').getContext('2d');

const chart = new Chart(chartCtx, {
  type: 'line',
  data: {
    labels: timeLabels,
    datasets: [
      { label: 'Harga', data: priceData, borderColor: 'black', fill: false },
      { label: 'EMA-12', data: [], borderColor: 'blue', fill: false },
      { label: 'EMA-26', data: [], borderColor: 'purple', fill: false },
      { label: 'Upper BB', data: [], borderColor: 'green', borderDash: [5,5], fill: false },
      { label: 'Lower BB', data: [], borderColor: 'red', borderDash: [5,5], fill: false },
      { label: 'SMA-10', data: [], borderColor: 'orange', fill: false },
    ]
  },
  options: { responsive: true, scales: { x: { display: true }, y: { display: true } } }
});

function log(msg) {
  const logDiv = document.getElementById("log");
  logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logDiv.textContent;
}

function updateCapitalDisplay() {
  document.getElementById("capital").textContent = `$${currentCapital.toFixed(2)}`;
}

function calculateSMA(data, period) {
  const result = [];
  for (let i = 0; i < data.length; i++) {
    if (i < period - 1) result.push(null);
    else result.push(data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0) / period);
  }
  return result;
}

function calculateEMA(data, period) {
  const result = [];
  const k = 2 / (period + 1);
  let emaPrev = data[0];
  result.push(emaPrev);
  for (let i = 1; i < data.length; i++) {
    const ema = data[i] * k + emaPrev * (1 - k);
    result.push(ema);
    emaPrev = ema;
  }
  return result;
}

function calculateBollingerBands(data, period = 20, multiplier = 2) {
  const sma = calculateSMA(data, period);
  const upper = [], lower = [];
  for (let i = 0; i < data.length; i++) {
    if (i < period - 1) {
      upper.push(null);
      lower.push(null);
    } else {
      const slice = data.slice(i - period + 1, i + 1);
      const mean = sma[i];
      const stdDev = Math.sqrt(slice.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / period);
      upper.push(mean + multiplier * stdDev);
      lower.push(mean - multiplier * stdDev);
    }
  }
  return { upper, lower };
}

function sendEmail(subject, body) {
  emailjs.send("service_5hxo1hk", "template_iq87egh", {
    subject: subject,
    body: body,
    time: new Date().toLocaleString()
  }).then(() => {
    log(`üìß Email terkirim: ${subject}`);
  }).catch(err => {
    log("‚ö†Ô∏è Gagal kirim email: " + err.text);
  });
}

function updateIndicators() {
  const sma10 = calculateSMA(priceData, 10);
  const ema12 = calculateEMA(priceData, 12);
  const ema26 = calculateEMA(priceData, 26);
  const bb = calculateBollingerBands(priceData);

  chart.data.datasets[1].data = ema12;
  chart.data.datasets[2].data = ema26;
  chart.data.datasets[3].data = bb.upper;
  chart.data.datasets[4].data = bb.lower;
  chart.data.datasets[5].data = sma10;
}

async function fetchAndEvaluate() {
  try {
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=pancakeswap-token&vs_currencies=usd");
    const data = await res.json();
    const price = parseFloat(data["pancakeswap-token"].usd);
    document.getElementById("livePrice").textContent = `Harga: $${price.toFixed(4)}`;

    const now = new Date().toLocaleTimeString();
    priceData.push(price);
    timeLabels.push(now);
    if (priceData.length > 100) {
      priceData.shift();
      timeLabels.shift();
    }
    updateIndicators();
    chart.update();

    if (!lastBuy) {
      const lowest = Math.min(...priceData.slice(-50));

      if (price <= lowest) {
        if (!buySignalStart) {
          buySignalStart = Date.now();
          localStorage.setItem("buySignalStart_cake", buySignalStart);
          log(`‚è≥ Sinyal BUY CAKE terdeteksi, tunggu konfirmasi 15 menit...`);
        } else {
          const elapsed = (Date.now() - buySignalStart) / 1000;
          if (elapsed >= 900) {
            lastBuy = price;
            highestSinceBuy = price;
            currentPositionAmount = qtyPerTrade / price;
            currentCapital -= qtyPerTrade;
            updateCapitalDisplay();
            log(`üì• BUY CAKE di $${price.toFixed(4)} setelah konfirmasi 15 menit`);
            sendEmail("BUY Signal CAKE", `Beli CAKE di $${price.toFixed(4)} setelah konfirmasi 15 menit`);
            buySignalStart = null;
            localStorage.removeItem("buySignalStart_cake");
          } else {
            log(`‚è≥ Sinyal BUY bertahan ${(elapsed/60).toFixed(1)} menit, tunggu sampai 15 menit...`);
          }
        }
      } else {
        buySignalStart = null;
        localStorage.removeItem("buySignalStart_cake");
        log(`‚è≥ Tunggu harga | Sekarang: $${price.toFixed(4)} | Terendah: $${lowest.toFixed(4)}`);
      }
    } else {
      if (price > highestSinceBuy) highestSinceBuy = price;
      const drop = ((highestSinceBuy - price) / highestSinceBuy) * 100;
      const loss = ((lastBuy - price) / lastBuy) * 100;

      if (drop > 1.0) {
        const sellValue = price * currentPositionAmount;
        currentCapital += sellValue;
        updateCapitalDisplay();
        log(`üì§ SELL CAKE (Trailing Profit) di $${price.toFixed(4)}`);
        sendEmail("SELL CAKE (Trailing Profit)", `Jual CAKE di $${price.toFixed(4)} | Modal: $${currentCapital.toFixed(2)}`);
        lastBuy = null; highestSinceBuy = null; currentPositionAmount = 0;
      } else if (loss > 1.5) {
        const sellValue = price * currentPositionAmount;
        currentCapital += sellValue;
        updateCapitalDisplay();
        log(`üì§ SELL CAKE (Cut Loss) di $${price.toFixed(4)} | Rugi: ${loss.toFixed(2)}%`);
        sendEmail("SELL CAKE (Cut Loss)", `Cut loss CAKE di $${price.toFixed(4)} | Modal: $${currentCapital.toFixed(2)}`);
        lastBuy = null; highestSinceBuy = null; currentPositionAmount = 0;
      } else {
        log(`‚è≥ HOLD CAKE | Harga: $${price.toFixed(4)} | Peak: $${highestSinceBuy.toFixed(4)}`);
      }
    }

    localStorage.setItem("capital_cake", currentCapital);
    localStorage.setItem("lastBuy_cake", lastBuy ?? "");
    localStorage.setItem("highestSinceBuy_cake", highestSinceBuy ?? "");
    localStorage.setItem("currentPositionAmount_cake", currentPositionAmount);

  } catch (err) {
    log("‚ùå Gagal ambil harga CAKE");
    console.error(err);
  }
}

updateCapitalDisplay();
setInterval(fetchAndEvaluate, 15000);
fetchAndEvaluate();
</script>
</body>
</html>
