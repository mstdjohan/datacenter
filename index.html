<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitor Harga CAKE & TON</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    h1 { margin-bottom: 20px; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    .pair-box {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 5px #ddd;
    }
    .price { font-size: 1.5em; margin: 5px 0; }
    .trend { font-weight: bold; margin-bottom: 10px; }
    .up { color: green; }
    .down { color: red; }
    label { display: block; font-size: 0.9em; margin: 5px 0; }
    input, textarea {
      width: 80px;
      text-align: center;
    }
    canvas {
      max-width: 100%;
      height: 200px;
      margin-top: 10px;
    }
    button {
      margin-top: 5px;
      font-size: 0.9em;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h1>üìä Monitor Harga CAKE & TON</h1>
  <div class="grid">
    <div class="pair-box">
      <h3>TON/USDT</h3>
      <div id="price-ton" class="price">Memuat...</div>
      <div id="trend-ton" class="trend">-</div>
      <label>Batas Atas: <input type="number" id="upper-ton" value="2.80" step="0.01" /></label>
      <label>Batas Bawah: <input type="number" id="lower-ton" value="2.60" step="0.01" /></label>
      <textarea id="note-ton" placeholder="Catatan alarm" rows="2" style="width:90%;"></textarea>
      <button onclick="saveLimits('ton')">Simpan</button>
      <button onclick="testNotification('ton')">üîî Uji Notifikasi</button>
      <button onclick="sendWhatsApp('ton')">üì≤ WhatsApp</button>
      <canvas id="chart-ton"></canvas>
    </div>
    <div class="pair-box">
      <h3>CAKE/USDT</h3>
      <div id="price-cake" class="price">Memuat...</div>
      <div id="trend-cake" class="trend">-</div>
      <label>Batas Atas: <input type="number" id="upper-cake" value="2.68" step="0.01" /></label>
      <label>Batas Bawah: <input type="number" id="lower-cake" value="2.58" step="0.01" /></label>
      <textarea id="note-cake" placeholder="Catatan alarm" rows="2" style="width:90%;"></textarea>
      <button onclick="saveLimits('cake')">Simpan</button>
      <button onclick="testNotification('cake')">üîî Uji Notifikasi</button>
      <button onclick="sendWhatsApp('cake')">üì≤ WhatsApp</button>
      <canvas id="chart-cake"></canvas>
    </div>
  </div>
  <audio id="alarm" src="https://www.soundjay.com/buttons/beep-07.wav" preload="auto"></audio>
  <script>
    const alarmSound = document.getElementById("alarm");

    const pairs = {
      ton: {
        name: "TON/USDT",
        api: "https://api.dexscreener.com/latest/dex/pairs/bsc/0x819a26d0c6f3af2b9fe4e9c4bcac04fcb3ea7f2a",
        canvas: "chart-ton",
        priceEl: "price-ton",
        trendEl: "trend-ton",
        upperId: "upper-ton",
        lowerId: "lower-ton",
        noteId: "note-ton",
        priceHistory: [],
        timeLabels: [],
        lastPrice: null,
        lastAlert: null,
        chart: null,
        upperLimit: 2.80,
        lowerLimit: 2.60
      },
      cake: {
        name: "CAKE/USDT",
        api: "https://api.dexscreener.com/latest/dex/pairs/bsc/0x0eD7e52944161450477ee417DE9Cd3a859b14fD0",
        canvas: "chart-cake",
        priceEl: "price-cake",
        trendEl: "trend-cake",
        upperId: "upper-cake",
        lowerId: "lower-cake",
        noteId: "note-cake",
        priceHistory: [],
        timeLabels: [],
        lastPrice: null,
        lastAlert: null,
        chart: null,
        upperLimit: 2.68,
        lowerLimit: 2.58
      }
    };

    function saveLimits(key) {
      const pair = pairs[key];
      pair.upperLimit = parseFloat(document.getElementById(pair.upperId).value);
      pair.lowerLimit = parseFloat(document.getElementById(pair.lowerId).value);
      alert(`‚úÖ Alarm ${pair.name} disimpan:
Atas: $${pair.upperLimit}
Bawah: $${pair.lowerLimit}`);
    }

    function testNotification(key) {
      const pair = pairs[key];
      const note = document.getElementById(pair.noteId).value || "";
      if (Notification.permission === "granted") {
        new Notification(`Alarm: ${pair.name}`, {
          body: `Batas harga tercapai! ${note}`
        });
        if ("vibrate" in navigator) {
          navigator.vibrate([200, 100, 200]);
        }
      } else {
        Notification.requestPermission().then(p => {
          if (p === "granted") testNotification(key);
        });
      }
    }

    function sendWhatsApp(key) {
      const pair = pairs[key];
      const note = document.getElementById(pair.noteId).value || "";
      const price = document.getElementById(pair.priceEl).textContent;
      const msg = encodeURIComponent(`üö® ${pair.name} menyentuh harga ${price}
Catatan: ${note}`);
      window.open(`https://wa.me/?text=${msg}`, "_blank");
    }

    function initCharts() {
      for (const key in pairs) {
        const pair = pairs[key];
        const ctx = document.getElementById(pair.canvas).getContext("2d");
        pair.chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: pair.timeLabels,
            datasets: [{
              label: `Harga ${pair.name}`,
              data: pair.priceHistory,
              borderColor: "blue",
              backgroundColor: "rgba(0,0,255,0.1)",
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            scales: {
              x: { display: false },
              y: { title: { display: true, text: "USD" } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    async function fetchPrices() {
      const now = new Date().toLocaleTimeString();
      for (const key in pairs) {
        const pair = pairs[key];
        try {
          const res = await fetch(pair.api);
          const data = await res.json();
          const price = parseFloat(data.pair.priceUsd);
          document.getElementById(pair.priceEl).textContent = `$${price.toFixed(4)}`;
          const trendEl = document.getElementById(pair.trendEl);
          if (pair.lastPrice !== null) {
            trendEl.textContent = price > pair.lastPrice ? "Naik" : price < pair.lastPrice ? "Turun" : "Stabil";
            trendEl.className = "trend " + (price > pair.lastPrice ? "up" : price < pair.lastPrice ? "down" : "");
          }

          if ((price >= pair.upperLimit || price <= pair.lowerLimit) && pair.lastAlert !== price) {
            alarmSound.play();
            testNotification(key);
            pair.lastAlert = price;
          }

          pair.priceHistory.push(price);
          pair.timeLabels.push(now);
          if (pair.priceHistory.length > 20) {
            pair.priceHistory.shift();
            pair.timeLabels.shift();
          }
          pair.chart.update();
          pair.lastPrice = price;
        } catch (err) {
          document.getElementById(pair.priceEl).textContent = "‚ùå Error";
          console.error(`Gagal ambil harga ${pair.name}:`, err);
        }
      }
    }

    initCharts();
    fetchPrices();
    setInterval(fetchPrices, 30000);
  </script>
</body>
</html>