<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buy Low / Sell High Auto-Executor — Chart + Wallet</title>
  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <!-- Ethers.js for wallet interaction -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <!-- WalletConnect v1 provider (for Trust Wallet mobile via WalletConnect) -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Helvetica Neue', Arial; margin:0; padding:0; background:#0f1724; color:#e6eef8 }
    header{padding:16px 20px; display:flex; align-items:center; gap:16px}
    .brand{font-weight:700; font-size:18px}
    #controls{display:flex; gap:8px; align-items:center}
    button{background:#1f2937;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    input, select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0b1220;color:#fff}
    #chart {height:520px}
    .panel{padding:12px; display:flex; gap:12px; flex-wrap:wrap}
    .status{font-size:13px; color:#9fb0d6}
    .signal{font-weight:700}
    .signal.buy{color:#34d399}
    .signal.sell{color:#fb7185}
    footer{padding:12px;color:#9fb0d6;font-size:13px}
    .small{font-size:13px;color:#9fb0d6}
    .danger{color:#ff7b7b}
    .card{background:#071027;padding:12px;border-radius:10px}
    label.switch{display:flex;align-items:center;gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="brand">AutoExec BuyLow/SellHigh — Chart + Wallet</div>
    <div id="controls">
      <select id="symbol"><option>CAKEUSDT</option><option>BTCUSDT</option><option>ETHUSDT</option></select>
      <select id="interval"><option value="1h">1h</option><option value="4h">4h</option><option value="1d">1d</option></select>
      <label>Pivot Len <input id="pivotLen" type="number" min="1" value="14" style="width:70px"/></label>
      <label>RSI <input id="rsiLen" type="number" min="1" value="14" style="width:70px"/></label>
      <label>EMA <input id="emaLen" type="number" min="1" value="200" style="width:80px"/></label>
      <button id="load">Load Chart</button>
    </div>
  </header>

  <div class="panel">
    <div style="flex:1; min-width:480px">
      <div id="chart"></div>
    </div>
    <div style="width:380px">
      <div class="card">
        <div class="status">Wallet status: <span id="walletStatus">Not connected</span></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="connectMeta">Connect MetaMask</button>
          <button id="connectWC">Connect Trust/WalletConnect</button>
        </div>
        <div style="margin-top:12px">
          <div>Connected address:</div>
          <div id="addr" style="word-break:break-all;color:#cfe8ff">-</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Auto-Execution Settings</div>
        <div class="small">Router (BSC Pancake v2 default): <code id="routerAddr">0x10ED43C718714eb63d5aA57B78B54704E256024E</code></div>
        <div style="margin-top:8px">
          <label class="small">Token address (target token for BUY/SELL):</label>
          <input id="tokenAddr" placeholder="0x..." style="width:100%" />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="amountBNB" placeholder="Amount BNB (for BUY)" style="flex:1" />
          <input id="amountToken" placeholder="Amount Token (for SELL)" style="flex:1" />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="slippage" type="number" value="1" style="width:80px" /> <span class="small">% slippage</span>
          <input id="gasLimit" type="number" value="300000" style="width:120px" /> <span class="small">gasLimit</span>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <label class="switch small">Enable Auto-Buy <input type="checkbox" id="enableAutoBuy"/></label>
          <label class="switch small">Enable Auto-Sell <input type="checkbox" id="enableAutoSell"/></label>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="confirmAuto" style="background:#2563eb">Confirm & Activate</button>
          <button id="deactivate" style="background:#374151">Deactivate</button>
        </div>

        <div style="margin-top:8px" class="small">
          <div class="danger">Peringatan: Otomatis mengeksekusi transaksi berisiko. Pastikan kamu memahami kontrak token dan set slippage yang wajar. Saya tetap akan meminta konfirmasi terakhir sebelum mengirim tx.</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Last signal & actions</div>
        <div>Type: <span id="lastType">-</span></div>
        <div>Price: <span id="lastPrice">-</span></div>
        <div>Time: <span id="lastTime">-</span></div>
        <div style="margin-top:8px">
          <button id="manualBuy">Manual Market BUY</button>
          <button id="manualSell">Manual Market SELL</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Notes</div>
        <div class="small">Skrip ini: mendeteksi pivot local + filter RSI & EMA. Otomatisasi akan menunggu sinyal lalu menampilkan confirm dialog. Untuk swap, gunakan router yang sesuai (default: PancakeSwap v2 pada BSC). Periksa token address, slippage, dan jumlah sebelum aktifkan.</div>
      </div>
    </div>
  </div>

  <footer>Made for you — buka file .html di browser. Kode melakukan swap via wallet (MetaMask/WalletConnect) dan memerlukan konfirmasi pengguna per transaksi.</footer>

<script>
// ---------- Utilities for TA (same as before) ----------
function ema(values, period){
  const k = 2/(period+1);
  let emaArr = [];
  let prev = values[0];
  for(let i=0;i<values.length;i++){
    if(i===0) prev = values[0];
    else prev = values[i]*k + prev*(1-k);
    emaArr.push(prev);
  }
  return emaArr;
}

function rsi(values, period){
  let gains = 0, losses = 0;
  for(let i=1;i<=period;i++){
    const change = values[i]-values[i-1];
    if(change>0) gains += change; else losses -= Math.min(change,0);
  }
  gains /= period; losses /= period;
  let rs = gains/(losses||1e-8);
  let out = [100 - 100/(1+rs)];
  for(let i=period+1;i<values.length;i++){
    const change = values[i]-values[i-1];
    let g = change>0?change:0;
    let l = change<0?-change:0;
    gains = (gains*(period-1)+g)/period;
    losses = (losses*(period-1)+l)/period;
    rs = gains/(losses||1e-8);
    out.push(100 - 100/(1+rs));
  }
  let pad = Array(period).fill(null);
  return pad.concat(out);
}

function pivotHigh(highs, left, right){
  const out = Array(highs.length).fill(false);
  for(let i=left;i<highs.length-right;i++){
    let ok = true;
    for(let j=1;j<=left;j++) if(highs[i-j] >= highs[i]) ok=false;
    for(let j=1;j<=right;j++) if(highs[i+j] > highs[i]) ok=false;
    if(ok) out[i]=true;
  }
  return out;
}
function pivotLow(lows, left, right){
  const out = Array(lows.length).fill(false);
  for(let i=left;i<lows.length-right;i++){
    let ok = true;
    for(let j=1;j<=left;j++) if(lows[i-j] <= lows[i]) ok=false;
    for(let j=1;j<=right;j++) if(lows[i+j] < lows[i]) ok=false;
    if(ok) out[i]=true;
  }
  return out;
}

// ---------- Chart and data ----------
let chart = null;
let candleSeries = null;
let lastSignal = null;
let pollingInterval = null;

async function fetchKlines(symbol, interval, limit=500){
  const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.map(d=>({ time: Math.floor(d[0]/1000), open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4]) }));
}

function drawChart(candles){
  if(chart) chart.remove();
  const container = document.getElementById('chart');
  container.innerHTML='';
  chart = LightweightCharts.createChart(container, { layout: {background:'#071027', textColor:'#d9e9ff'}, grid:{vertLines:{color:'#0b1220'}, horzLines:{color:'#0b1220'}}, rightPriceScale:{borderColor:'#0b1220'}, timeScale:{borderColor:'#0b1220'} });
  candleSeries = chart.addCandlestickSeries();
  candleSeries.setData(candles);
}

function plotSignals(candles, buyIdxs, sellIdxs){
  const markers = [];
  buyIdxs.forEach(i=>{ markers.push({time:candles[i].time, position:'belowBar', color:'#34d399', shape:'arrowUp', text:'BUY'}); });
  sellIdxs.forEach(i=>{ markers.push({time:candles[i].time, position:'aboveBar', color:'#fb7185', shape:'arrowDown', text:'SELL'}); });
  candleSeries.setMarkers(markers);
}

async function computeAndPlot(symbol, interval, pivotLen, rsiLen, emaLen){
  try{
    const candles = await fetchKlines(symbol, interval, 1000);
    drawChart(candles);
    const closes = candles.map(c=>c.close);
    const highs = candles.map(c=>c.high);
    const lows = candles.map(c=>c.low);
    const emaArr = ema(closes, emaLen);
    const rsiArr = rsi(closes, rsiLen);
    const ph = pivotHigh(highs, pivotLen, pivotLen);
    const pl = pivotLow(lows, pivotLen, pivotLen);

    const buyIdxs = [];
    const sellIdxs = [];
    for(let i=0;i<candles.length;i++){
      const r = rsiArr[i];
      const price = closes[i];
      const e = emaArr[i] || null;
      if(pl[i] && r !== null && r !== undefined && r < 35 && (e && price > e*0.9)){
        buyIdxs.push(i);
        lastSignal = {type:'BUY', price:price, time:candles[i].time};
      }
      if(ph[i] && r !== null && r !== undefined && r > 65 && (e && price < e*1.1)){
        sellIdxs.push(i);
        lastSignal = {type:'SELL', price:price, time:candles[i].time};
      }
    }
    plotSignals(candles, buyIdxs, sellIdxs);
    updateLastSignalUI(lastSignal);
    return {candles, lastSignal};
  }catch(err){ console.error(err); alert('Gagal ambil data: '+err.message); }
}

function updateLastSignalUI(sig){
  if(!sig){ document.getElementById('lastType').innerText='-'; document.getElementById('lastPrice').innerText='-'; document.getElementById('lastTime').innerText='-'; return; }
  document.getElementById('lastType').innerText = sig.type;
  document.getElementById('lastPrice').innerText = sig.price;
  const d = new Date(sig.time*1000);
  document.getElementById('lastTime').innerText = d.toLocaleString();
}

// ---------- Wallet connections (MetaMask & WalletConnect) ----------
let ethersProvider = null;
let wcProvider = null;
let signer = null;
let userAddress = null;

async function connectMetaMask(){
  if(!window.ethereum){ alert('MetaMask tidak tersedia di browser ini.'); return; }
  try{ await window.ethereum.request({method:'eth_requestAccounts'}); ethersProvider = new ethers.providers.Web3Provider(window.ethereum); signer = ethersProvider.getSigner(); userAddress = await signer.getAddress(); document.getElementById('walletStatus').innerText='Connected (MetaMask)'; document.getElementById('addr').innerText = userAddress; }catch(e){ console.error(e); alert('Gagal connect MetaMask: '+e.message); }
}

async function connectWalletConnect(){
  try{
    const provider = new WalletConnectProvider.default({ rpc: {56: 'https://bsc-dataseed.binance.org/'}, chainId:56 });
    await provider.enable(); wcProvider = provider; ethersProvider = new ethers.providers.Web3Provider(provider); signer = ethersProvider.getSigner(); userAddress = await signer.getAddress(); document.getElementById('walletStatus').innerText='Connected (WalletConnect)'; document.getElementById('addr').innerText = userAddress;
  }catch(e){ console.error(e); alert('Gagal connect WalletConnect: '+e.message); }
}

// ---------- Swap helpers (PancakeSwap V2 style) ----------
const WBNB = '0xBB4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c'; // BSC mainnet WBNB

function toWei(amount){ try{return ethers.utils.parseEther(String(amount)); }catch(e){ return null; }}

async function approveIfNeeded(tokenAddr, routerAddr, amount, providerSigner){
  const erc20 = new ethers.Contract(tokenAddr, ["function allowance(address owner, address spender) view returns (uint256)", "function approve(address spender, uint256 amount) returns (bool)"], providerSigner);
  const allowance = await erc20.allowance(userAddress, routerAddr);
  if(allowance.lt(amount)){
    const tx = await erc20.approve(routerAddr, amount);
    await tx.wait();
  }
}

async function executeMarketBuy(tokenAddress, amountBNB, slippagePercent, routerAddr){
  if(!signer) throw new Error('Wallet belum terhubung');
  // Using swapExactETHForTokensSupportingFeeOnTransferTokens
  const routerAbi = [
    'function swapExactETHForTokensSupportingFeeOnTransferTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable',
    'function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)'
  ];
  const router = new ethers.Contract(routerAddr, routerAbi, signer);
  const path = [WBNB, tokenAddress];
  const amountIn = toWei(amountBNB);
  // estimate amountsOut
  const provider = ethersProvider.provider || ethersProvider;
  const routerRead = new ethers.Contract(routerAddr, ['function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)'], provider);
  const amounts = await routerRead.getAmountsOut(amountIn, path);
  const amountOutEstimated = amounts[1];
  const amountOutMin = amountOutEstimated.mul(ethers.BigNumber.from(100 - Math.floor(slippagePercent))).div(100);
  const deadline = Math.floor(Date.now()/1000) + 60*5;
  // ask final confirmation
  const confirmText = `Auto-BUY
Token: ${tokenAddress}
Amount BNB: ${amountBNB}
Estimated tokens: ${amountOutEstimated.toString()}
Slippage: ${slippagePercent}%

Ketik CONFIRM untuk mengirim`;
  const answer = prompt(confirmText, '');
  if(answer !== 'CONFIRM') throw new Error('User cancelled');
  const tx = await router.swapExactETHForTokensSupportingFeeOnTransferTokens(amountOutMin, path, userAddress, deadline, { value: amountIn, gasLimit: document.getElementById('gasLimit').value || 300000 });
  return tx;
}

async function executeMarketSell(tokenAddress, amountToken, slippagePercent, routerAddr){
  if(!signer) throw new Error('Wallet belum terhubung');
  const routerAbi = [
    'function swapExactTokensForETHSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external',
    'function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)'
  ];
  const router = new ethers.Contract(routerAddr, routerAbi, signer);
  const path = [tokenAddress, WBNB];
  const amountIn = toWei(amountToken);
  // approval
  await approveIfNeeded(tokenAddress, routerAddr, amountIn, signer);
  const provider = ethersProvider.provider || ethersProvider;
  const routerRead = new ethers.Contract(routerAddr, ['function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)'], provider);
  const amounts = await routerRead.getAmountsOut(amountIn, path);
  const amountOutEstimated = amounts[1];
  const amountOutMin = amountOutEstimated.mul(ethers.BigNumber.from(100 - Math.floor(slippagePercent))).div(100);
  const deadline = Math.floor(Date.now()/1000) + 60*5;
  const confirmText = `Auto-SELL
Token: ${tokenAddress}
Amount Token: ${amountToken}
Estimated BNB: ${amountOutEstimated.toString()}
Slippage: ${slippagePercent}%

Ketik CONFIRM untuk mengirim`;
  const answer = prompt(confirmText, '');
  if(answer !== 'CONFIRM') throw new Error('User cancelled');
  const tx = await router.swapExactTokensForETHSupportingFeeOnTransferTokens(amountIn, amountOutMin, path, userAddress, deadline, { gasLimit: document.getElementById('gasLimit').value || 300000 });
  return tx;
}

// ---------- Auto execution logic ----------
let autoActive = false;

async function checkAndMaybeExecute(){
  const sym = document.getElementById('symbol').value.trim();
  const interval = document.getElementById('interval').value;
  const pivotLen = parseInt(document.getElementById('pivotLen').value);
  const rsiLen = parseInt(document.getElementById('rsiLen').value);
  const emaLen = parseInt(document.getElementById('emaLen').value);
  const {candles, lastSignal} = await computeAndPlot(sym, interval, pivotLen, rsiLen, emaLen);
  if(!lastSignal) return;
  const tokenAddr = document.getElementById('tokenAddr').value.trim();
  const sl = parseFloat(document.getElementById('slippage').value) || 1;
  if(document.getElementById('enableAutoBuy').checked && lastSignal.type === 'BUY' && tokenAddr){
    // execute market buy
    try{
      document.getElementById('walletStatus').innerText = 'Ready to BUY (confirming)';
      const amountBNB = parseFloat(document.getElementById('amountBNB').value);
      if(!amountBNB) throw new Error('Isi amount BNB');
      const tx = await executeMarketBuy(tokenAddr, amountBNB, sl, document.getElementById('routerAddr').innerText);
      alert('Buy tx sent: '+tx.hash);
    }catch(e){ console.error(e); alert('Buy canceled/failed: '+(e.message||e)); }
  }
  if(document.getElementById('enableAutoSell').checked && lastSignal.type === 'SELL' && tokenAddr){
    try{
      document.getElementById('walletStatus').innerText = 'Ready to SELL (confirming)';
      const amountToken = parseFloat(document.getElementById('amountToken').value);
      if(!amountToken) throw new Error('Isi amount token');
      const tx = await executeMarketSell(tokenAddr, amountToken, sl, document.getElementById('routerAddr').innerText);
      alert('Sell tx sent: '+tx.hash);
    }catch(e){ console.error(e); alert('Sell canceled/failed: '+(e.message||e)); }
  }
}

// activation buttons
document.getElementById('confirmAuto').addEventListener('click', async ()=>{
  // require explicit typed confirmation and checkbox
  const typed = prompt('Untuk mengaktifkan Auto-Execute, ketik I UNDERSTAND');
  if(typed !== 'I UNDERSTAND'){ alert('Konfirmasi gagal — ketik I UNDERSTAND untuk setuju'); return; }
  if(!userAddress){ alert('Hubungkan wallet dulu'); return; }
  autoActive = true;
  if(pollingInterval) clearInterval(pollingInterval);
  pollingInterval = setInterval(()=>{ if(autoActive) checkAndMaybeExecute(); }, 15000); // cek tiap 15s
  alert('Auto-Execute aktif. Script akan cek sinyal tiap 15 detik dan meminta konfirmasi sebelum mengirim tx.');
});

document.getElementById('deactivate').addEventListener('click', ()=>{ autoActive=false; if(pollingInterval) clearInterval(pollingInterval); alert('Auto-Execute dinonaktifkan'); });

// manual actions
document.getElementById('manualBuy').addEventListener('click', async ()=>{
  try{
    const tokenAddr = document.getElementById('tokenAddr').value.trim();
    const amountBNB = parseFloat(document.getElementById('amountBNB').value);
    const sl = parseFloat(document.getElementById('slippage').value) || 1;
    if(!tokenAddr || !amountBNB) return alert('Isi token address dan amount BNB');
    const tx = await executeMarketBuy(tokenAddr, amountBNB, sl, document.getElementById('routerAddr').innerText);
    alert('Buy tx sent: '+tx.hash);
  }catch(e){ alert('Manual buy failed: '+(e.message||e)); }
});

document.getElementById('manualSell').addEventListener('click', async ()=>{
  try{
    const tokenAddr = document.getElementById('tokenAddr').value.trim();
    const amountToken = parseFloat(document.getElementById('amountToken').value);
    const sl = parseFloat(document.getElementById('slippage').value) || 1;
    if(!tokenAddr || !amountToken) return alert('Isi token address dan amount token');
    const tx = await executeMarketSell(tokenAddr, amountToken, sl, document.getElementById('routerAddr').innerText);
    alert('Sell tx sent: '+tx.hash);
  }catch(e){ alert('Manual sell failed: '+(e.message||e)); }
});

// ---------- UI bindings ----------
document.getElementById('load').addEventListener('click', ()=>{
  const sym = document.getElementById('symbol').value.trim();
  const interval = document.getElementById('interval').value;
  const pivotLen = parseInt(document.getElementById('pivotLen').value);
  const rsiLen = parseInt(document.getElementById('rsiLen').value);
  const emaLen = parseInt(document.getElementById('emaLen').value);
  computeAndPlot(sym, interval, pivotLen, rsiLen, emaLen);
});

document.getElementById('connectMeta').addEventListener('click', connectMetaMask);
document.getElementById('connectWC').addEventListener('click', connectWalletConnect);

// load default
window.addEventListener('load', ()=>{ document.getElementById('load').click(); });
</script>
</body>
</html>
